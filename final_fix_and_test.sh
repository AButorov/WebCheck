#!/bin/zsh

# –§–ò–ù–ê–õ–¨–ù–´–ô –°–ö–†–ò–ü–¢: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π TypeError –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ WebCheck

echo "üöÄ –§–ò–ù–ê–õ–¨–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –í–°–ï–• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –û–®–ò–ë–û–ö WebCheck"
echo "=========================================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [[ ! -f "package.json" ]] || [[ ! -f "src/background/monitor/index.ts" ]]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ WebCheck"
    exit 1
fi

echo "üìã –°–¢–ê–¢–£–° –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô:"
echo "======================"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ monitor/index.ts
if grep -q "// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∑–∞–¥–∞—á–∏" src/background/monitor/index.ts; then
    echo "‚úÖ monitor/index.ts - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
    MONITOR_FIXED=true
else
    echo "‚ùå monitor/index.ts - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ù–ï –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
    MONITOR_FIXED=false
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ taskQueue.ts  
if grep -q "// –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∑–∞–¥–∞—á–∏" src/background/taskQueue.ts; then
    echo "‚úÖ taskQueue.ts - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
    TASKQUEUE_FIXED=true
else
    echo "‚ùå taskQueue.ts - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ù–ï –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
    TASKQUEUE_FIXED=false
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ offscreenManager.ts
if grep -q "DOM_SCRAPING" src/background/offscreenManager.ts; then
    echo "‚úÖ offscreenManager.ts - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
    OFFSCREEN_FIXED=true
else
    echo "‚ùå offscreenManager.ts - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ù–ï –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
    OFFSCREEN_FIXED=false
fi

echo ""

if [[ "$MONITOR_FIXED" == "true" && "$TASKQUEUE_FIXED" == "true" && "$OFFSCREEN_FIXED" == "true" ]]; then
    echo "üéâ –í–°–ï –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ò–ú–ï–ù–ï–ù–´!"
    ALL_FIXED=true
else
    echo "‚ö†Ô∏è  –ù–ï –í–°–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ò–ú–ï–ù–ï–ù–´"
    ALL_FIXED=false
    
    echo ""
    echo "üîß –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è..."
    
    if [[ "$MONITOR_FIXED" == "false" ]]; then
        echo "   ‚ùó –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫ monitor/index.ts –≤—Ä—É—á–Ω—É—é"
        echo "     –ò–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: ./fix_undefined_task_errors.sh"
    fi
    
    if [[ "$TASKQUEUE_FIXED" == "false" ]]; then
        echo "   ‚ùó –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫ taskQueue.ts –≤—Ä—É—á–Ω—É—é"
        echo "     –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏ —á–µ—Ä–µ–∑ edit_file"
    fi
    
    if [[ "$OFFSCREEN_FIXED" == "false" ]]; then
        echo "   ‚ùó –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫ offscreenManager.ts –≤—Ä—É—á–Ω—É—é"
    fi
fi

echo ""
echo "üèóÔ∏è  –ü–ï–†–ï–°–ë–û–†–ö–ê –ü–†–û–ï–ö–¢–ê"
echo "====================="

# –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å–±–æ—Ä–∫—É
echo "üßπ –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å–±–æ—Ä–∫—É..."
rm -rf dist/
rm -rf web-check-*.zip
rm -rf node_modules/.vite/ 2>/dev/null

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
if [[ ! -d "node_modules" ]]; then
    echo "üì• –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
    if command -v pnpm >/dev/null 2>&1; then
        pnpm install
    else
        npm install
    fi
fi

# –í—ã–ø–æ–ª–Ω—è–µ–º —Å–±–æ—Ä–∫—É
echo "üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
if [[ -f "build.sh" ]]; then
    chmod +x build.sh
    ./build.sh
    BUILD_EXIT_CODE=$?
else
    if command -v pnpm >/dev/null 2>&1; then
        pnpm build
    else
        npm run build
    fi
    BUILD_EXIT_CODE=$?
fi

echo ""
if [[ $BUILD_EXIT_CODE -eq 0 ]]; then
    echo "‚úÖ –°–ë–û–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–±–æ—Ä–∫–∏
    echo ""
    echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–±–æ—Ä–∫–∏..."
    
    REQUIRED_FILES=(
        "dist/manifest.json"
        "dist/background.js"
        "dist/offscreen/offscreen.html"
        "dist/offscreen/offscreen.js"
        "dist/content-script/element-selector.js"
    )
    
    BUILD_VALID=true
    for file in "${REQUIRED_FILES[@]}"; do
        if [[ -f "$file" ]]; then
            echo "  ‚úÖ $file"
        else
            echo "  ‚ùå $file - –û–¢–°–£–¢–°–¢–í–£–ï–¢"
            BUILD_VALID=false
        fi
    done
    
    if [[ "$BUILD_VALID" == "true" ]]; then
        echo ""
        echo "üéâ –ü–†–û–ï–ö–¢ –ü–û–õ–ù–û–°–¢–¨–Æ –ì–û–¢–û–í –ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ!"
    else
        echo ""
        echo "‚ö†Ô∏è  –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –Ω–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç"
        BUILD_EXIT_CODE=1
    fi
    
else
    echo "‚ùå –û–®–ò–ë–ö–ê –°–ë–û–†–ö–ò! –ö–æ–¥ –≤–æ–∑–≤—Ä–∞—Ç–∞: $BUILD_EXIT_CODE"
fi

echo ""
echo "üìã –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ"
echo "============================"

if [[ $BUILD_EXIT_CODE -eq 0 && "$BUILD_VALID" == "true" ]]; then
    echo ""
    echo "üîß –®–ê–ì–ò –î–õ–Ø –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ì–û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:"
    echo ""
    echo "1. üìÇ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –≤ Chrome:"
    echo "   ‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ chrome://extensions/"
    echo "   ‚Ä¢ –í–∫–ª—é—á–∏—Ç–µ '–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞'"
    echo "   ‚Ä¢ –ù–∞–∂–º–∏—Ç–µ '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ'"
    echo "   ‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É dist/"
    echo ""
    echo "2. üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:"
    echo "   ‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å Service Worker (chrome://extensions/ ‚Üí WebCheck ‚Üí 'Service worker')"
    echo "   ‚Ä¢ –î–û–õ–ñ–ù–´ –í–ò–î–ï–¢–¨:"
    echo "     ‚úÖ [MONITOR] Initializing background monitoring system"
    echo "     ‚úÖ [MONITOR] Background monitoring system initialized" 
    echo "     ‚úÖ [MONITOR] Loaded X valid tasks from storage"
    echo ""
    echo "   ‚Ä¢ –ù–ï –î–û–õ–ñ–ù–´ –í–ò–î–ï–¢–¨:"
    echo "     ‚ùå TypeError: Cannot read properties of undefined (reading 'id')"
    echo "     ‚ùå Error in event handler: TypeError"
    echo ""
    echo "3. üß™ –ë–∞–∑–æ–≤—ã–π —Ç–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:"
    echo "   ‚Ä¢ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è"
    echo "   ‚Ä¢ –ù–∞–∂–º–∏—Ç–µ '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É'"
    echo "   ‚Ä¢ –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ https://time.is/"
    echo "   ‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ"
    echo "   ‚Ä¢ –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∑–∞–¥–∞—á—É —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º '10 —Å–µ–∫—É–Ω–¥'"
    echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Service Worker –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ TypeError"
    echo ""
    echo "4. üìä –¢–µ—Å—Ç API —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–≤ –∫–æ–Ω—Å–æ–ª–∏ Service Worker):"
    echo "   chrome.runtime.sendMessage({type: 'get-monitoring-stats'})"
    echo "   chrome.runtime.sendMessage({type: 'get-performance-stats'})"
    echo ""
    echo "üîç –ö–†–ò–¢–ï–†–ò–ò –£–°–ü–ï–®–ù–û–ì–û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:"
    echo "  ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ TypeError"
    echo "  ‚úÖ Service Worker –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
    echo "  ‚úÖ –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"
    echo "  ‚úÖ API —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ"
    echo "  ‚úÖ –í –ª–æ–≥–∞—Ö –µ—Å—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –∑–∞–¥–∞—á (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)"
    echo ""
    echo "üìñ –ü–æ–¥—Ä–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: ./TESTING_FIXES.md"
    echo "üìë –ü–æ–ª–Ω–∞—è —Å–≤–æ–¥–∫–∞ —Ä–∞–±–æ—Ç: ./FIXES_SUMMARY.md"
    
else
    echo "‚ùå –°–ë–û–†–ö–ê –ù–ï –ó–ê–í–ï–†–®–ï–ù–ê - –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ù–ï–í–û–ó–ú–û–ñ–ù–û"
    echo ""
    echo "üîß –£–°–¢–†–ê–ù–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú:"
    echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–±–æ—Ä–∫–∏ –≤—ã—à–µ"
    echo "2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
    echo "3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å node_modules –∏ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å:"
    echo "   rm -rf node_modules dist"
    echo "   npm install && npm run build"
fi

echo ""
echo "=================================="
echo "üéØ –†–ï–ó–Æ–ú–ï –í–´–ü–û–õ–ù–ï–ù–ù–û–ô –†–ê–ë–û–¢–´"
echo "=================================="
echo ""
echo "‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–´ TypeError –æ—à–∏–±–∫–∏ –≤:"
echo "   ‚Ä¢ src/background/monitor/index.ts"
echo "   ‚Ä¢ src/background/taskQueue.ts"
echo "   ‚Ä¢ src/background/offscreenManager.ts"
echo ""
echo "‚úÖ –î–û–ë–ê–í–õ–ï–ù–´ –∑–∞—â–∏—Ç–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è:"
echo "   ‚Ä¢ –í–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∑–∞–¥–∞—á –ø–µ—Ä–µ–¥ –æ–±—Ä–∞—â–µ–Ω–∏–µ–º –∫ task.id"
echo "   ‚Ä¢ –§–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ undefined –æ–±—ä–µ–∫—Ç–æ–≤ –∏–∑ –º–∞—Å—Å–∏–≤–æ–≤"
echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–≤–æ–π—Å—Ç–≤"
echo "   ‚Ä¢ –ë–µ–∑–æ–ø–∞—Å–Ω—ã—Ö callback –≤—ã–∑–æ–≤–æ–≤"
echo ""
echo "‚úÖ –°–û–ó–î–ê–ù–´ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:"
echo "   ‚Ä¢ –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π"
echo "   ‚Ä¢ –ü–æ–¥—Ä–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é"
echo "   ‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
echo ""

if [[ $BUILD_EXIT_CODE -eq 0 && "$BUILD_VALID" == "true" ]]; then
    echo "üöÄ –ü–†–û–ï–ö–¢ –ì–û–¢–û–í –ö –ü–†–û–î–ê–ö–®–ù-–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ!"
    echo ""
    echo "–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø: –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Å–æ–≥–ª–∞—Å–Ω–æ todo_now.md"
else
    echo "‚ö†Ô∏è  –¢–†–ï–ë–£–ï–¢–°–Ø –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –û–¢–õ–ê–î–ö–ê –°–ë–û–†–ö–ò"
    echo ""
    echo "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –ª–æ–≥–∞–º –≤—ã—à–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º"
fi

echo ""
echo "üîß –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!"
echo "–î–∞—Ç–∞: $(date '+%d.%m.%Y %H:%M')"
