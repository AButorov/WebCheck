# План перехода WebCheck на Offscreen Documents API (Manifest V3)

**Цель**: Заменить текущий механизм создания временных видимых вкладок для проверки изменений на использование скрытых offscreen-документов, чтобы процесс мониторинга стал невидимым для пользователя.

## 1. Подготовительные шаги

- [x] **Обновить `manifest.json`**:
  - [x] Добавить разрешение `"offscreen"` в массив `permissions`.
- [x] **Создать HTML-файл для offscreen-документа**:
  - [x] Создать файл `src/offscreen/offscreen.html`.
  - [x] Подключить в нем скрипт `src/offscreen/offscreen.js`.
- [x] **Создать JavaScript-файл для offscreen-документа**:
  - [x] Создать файл `src/offscreen/offscreen.js`.
- [x] **Настроить сборку**:
  - [x] Убедиться, что `offscreen.html` и `offscreen.js` копируются в директорию `dist/offscreen/` при сборке (обновить `vite.config.js` или ваш скрипт `build.sh`).

## 2. Управление жизненным циклом offscreen-документа

- [x] **Реализовать менеджер offscreen-документов в Service Worker** (в новом файле `src/background/offscreenManager.js` или интегрировать в существующую логику):
  - [x] Реализовать функцию `hasOffscreenDocument(path)` для проверки существования документа (используя `chrome.runtime.getContexts()`).
  - [x] Реализовать функцию `ensureOffscreenDocument(path)`:
    - [x] Проверяет наличие документа с помощью `hasOffscreenDocument`.
    - [x] Если документа нет, создает его с помощью `chrome.offscreen.createDocument()`.
    - [x] Использовать подходящую `reason` из `chrome.offscreen.Reason` (например, `USER_INPUT`, так как работа инициируется настройками пользователя, или другая, не накладывающая строгих временных ограничений).
    - [x] Предусмотреть параметр `justification` для `createDocument`.
    - [x] Реализовать механизм для предотвращения одновременного создания нескольких документов (например, с использованием промиса `creatingPromise`).

## 3. Модификация логики фонового мониторинга (`src/background/monitor/`)

- [x] **Интегрировать `ensureOffscreenDocument` в основной модуль мониторинга**:
  - [x] Вызывать `ensureOffscreenDocument()` перед каждой попыткой проверки URL, требующей DOM-доступа.
- [x] **Реализовать обмен сообщениями между Service Worker и `offscreen.js`**:
  - [x] **Service Worker (логика мониторинга)**:
    - [x] Создать функцию (например, `getContentViaOffscreen(url, selector)`) которая:
      - [x] Отправляет сообщение в `offscreen.js` с `url` и `selector` (используя `chrome.runtime.sendMessage`). Сообщение должно содержать уникальный идентификатор `target: 'offscreen'` и `type` (например, `PROCESS_URL`).
      - [x] Ожидает ответ от `offscreen.js` (возвращает Promise).
      - [x] Внедрить таймаут для ожидания ответа.
      - [x] Обработать `chrome.runtime.lastError` и ошибки, возвращенные из `offscreen.js`.
  - [x] **`src/offscreen/offscreen.js`**:
    - [x] Установить слушатель `chrome.runtime.onMessage.addListener` для приема сообщений от Service Worker.
    - [x] Проверять `message.target === 'offscreen'` и `message.type`.
- [x] **Реализовать извлечение контента страницы в `offscreen.js`**:
  - [x] **Создание и управление `<iframe>`**:
    - [x] При получении сообщения, динамически создать `<iframe>`.
    - [x] Установить `src` для `<iframe>` на полученный `url`.
    - [x] Сделать iframe невидимым.
    - [x] Добавить `<iframe>` в DOM `offscreen.html`.
    - [x] Настроить обработчики `iframe.onload` и `iframe.onerror`.
    - [x] Обязательно удалять `<iframe>` из DOM после завершения работы или при ошибке.
  - [x] **Получение контента из `<iframe>`**:
    - [x] Реализовано прямое извлечение контента через `iframe.contentDocument`
    - [x] Добавлено резервное решение через postMessage для CORS-ограниченных страниц
    - [x] Автоматическая инжекция скрипта в iframe для обработки postMessage
    - [x] Обновлен `manifest.json` для поддержки `"all_frames": true`
  - [x] **Отправка результата из `offscreen.js` обратно в Service Worker**:
    - [x] Использовать функцию `sendResponse()` из слушателя `onMessage` для отправки полученных данных (или сообщения об ошибке) обратно в Service Worker.
    - [x] Не забыть вернуть `true` из слушателя `onMessage` для поддержки асинхронного `sendResponse`.

## 4. Обработка ограничений и повышение надёжности

- [ ] **Реализовать очередь задач в Service Worker**:
  - [ ] Так как одновременно может существовать только один offscreen-документ, задачи по проверке URL должны обрабатываться последовательно, если они требуют DOM-доступа через offscreen-документ.
- [ ] **Усилить обработку ошибок и таймаутов**:
  - [ ] На всех этапах: создание offscreen-документа, отправка/прием сообщений, загрузка `<iframe>`, извлечение контента из `<iframe>`.
- [ ] **Продумать стратегию закрытия offscreen-документа**:
  - [ ] Рассмотреть возможность явного закрытия offscreen-документа (`chrome.offscreen.closeDocument()`) после завершения серии проверок или по таймауту неактивности, чтобы освободить ресурсы. Функция `ensureOffscreenDocument()` будет его пересоздавать по мере необходимости.

## 5. Тестирование и отладка

- [ ] **Провести всестороннее тестирование на различных типах веб-страниц**:
  - [ ] Статические HTML-страницы.
  - [ ] Динамические страницы (одностраничные приложения (SPA), страницы с активным JavaScript-рендерингом).
  - [ ] Страницы с различными Content Security Policy (CSP).
  - [ ] Страницы, требующие авторизации (продумать, как будут обрабатываться cookie и сессии в контексте `<iframe>` внутри offscreen-документа).
- [ ] **Протестировать сценарии ошибок**:
  - [ ] Ошибки загрузки URL в `<iframe>`.
  - [ ] Отслеживаемый элемент не найден на странице.
  - [ ] Превышение таймаутов.
  - [ ] Неожиданное закрытие offscreen-документа браузером.
- [ ] **Активно использовать инструменты разработчика Chrome**:
  - [ ] Для отладки Service Worker (доступ через `chrome://extensions/` -> ваше расширение -> "Service worker").
  - [ ] Для отладки `offscreen.js` (логи можно выводить в консоль Service Worker, или проверять существующие контексты расширения).
  - [ ] Для отладки Content Script, работающего внутри `<iframe>` (через инспектирование фрейма, если это возможно).

## 6. Документация и рефакторинг

- [ ] **Обновить комментарии в коде**, чтобы отразить новую архитектуру и логику работы с offscreen-документами.
- [ ] **Провести рефакторинг существующего кода** в `src/background/monitor/` для чистой интеграции новой системы мониторинга.
- [ ] **Обновить `README.md`** (и другие релевантные документы) для описания изменений в архитектуре и принципах работы фонового мониторинга.
