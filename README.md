# Web Check - расширение для отслеживания изменений на сайтах

## Обзор проекта

Web Check - интуитивно понятное расширение для браузера Google Chrome, позволяющее пользователям отслеживать изменения на конкретных элементах веб-страниц. Пользователи могут добавлять элементы для мониторинга, выбирать интервал проверки и получать уведомления при обнаружении изменений.

## Статус разработки (15.05.2025)

- [x] Создана базовая структура проекта на основе vite-vue3-browser-extension-v3
- [x] Настроены основные конфигурационные файлы (package.json, vite.config.ts, tsconfig.json)
- [x] Настроен Tailwind CSS согласно требованиям ТЗ
- [x] Созданы файлы локализации (en, ru)
- [x] Создан интерфейс управления задачами согласно ТЗ
- [x] Реализовано хранилище задач с использованием Pinia и Chrome Storage API
- [x] Созданы базовые скрипты (background, content-script)
- [x] Реализован базовый механизм проверки изменений
- [x] Реализовано отображение изменений в формате "было/стало"
- [x] Создан универсальный скрипт для сборки CSP-совместимой версии
- [x] Реализована поддержка строгой политики CSP в Manifest V3
- [x] Переработаны Vue-компоненты для работы без использования eval()
- [x] Решены проблемы с CSP-совместимостью в Manifest V3
- [x] Реализована ручная интернационализация без использования eval()
- [x] Улучшена обработка ошибок и логирование для отладки
- [x] Улучшен интерфейс управления задачами - более компактный и информативный
- [x] Добавлены новые кнопки управления задачами с иконками
- [x] Реализована цветовая схема согласно техническому заданию
- [x] Создан файл констант для удобного управления цветами и другими общими настройками
- [x] Создана страница настроек расширения
- [x] Оптимизирована система скриптов сборки
- [x] Исправлена ошибка инициализации i18n на странице настроек
- [x] Исправлены ошибки CSP и типизации в коде

## Выполненные работы (14.05.2025)

1. Создана основная структура расширения с использованием Vue 3, TypeScript и Vite
2. Реализован механизм хранения данных в Chrome Storage API
3. Создан интерфейс управления задачами согласно требованиям ТЗ
4. Разработан механизм проверки изменений на веб-страницах
5. Реализован компонент TaskCard для отображения информации о задачах
6. Создана страница просмотра изменений в формате "было/стало"
7. Решены проблемы с CSP-совместимостью в Manifest V3
8. Создан универсальный скрипт сборки с проверками и исправлениями
9. Улучшен интерфейс управления задачами
10. Оптимизирована система скриптов для упрощения процесса разработки

## Выполненные работы (15.05.2025)

1. Добавлена кнопка перехода в настройки на главном экране расширения
2. Исправлены стили карточек задач для большей совместимости с Tailwind CSS
3. Добавлена типизация для глобальных функций window.t и window.vueRouter
4. Отлажена работа интернационализации на странице настроек
5. Исправлена ошибка с функцией перевода 't' на странице настроек:
   - Изменён порядок инициализации `window.t` в main.ts (функция добавляется в window до создания приложения)
   - Создан вспомогательный модуль i18n-helper.ts с функцией перевода, которая имеет встроенный механизм запасного решения
   - Заменены прямые вызовы `window.t()` в шаблоне на `translate()`, которая использует запасную логику
6. Исправлены ошибки CSP и типизации в коде:
   - Удалены inline-скрипты из файла options/index.html для совместимости с CSP
   - Улучшена устойчивость функции перевода с защитой от ошибок типизации
   - Добавлена дополнительная обработка ошибок в функциях интернационализации
   - Исправлена ошибка "n.filter is not a function" с добавлением защиты от null/undefined значений

## Выполненные работы (15.05.2025 - дополнение)

1. Оптимизирован интерфейс popup-окна:
   - Увеличена кнопка добавления новой задачи и перемещена в правую часть интерфейса
   - Кнопка настроек перенесена в правый верхний угол и выровнена по размеру с кнопкой добавления задачи

2. Улучшен интерфейс карточки задачи (TaskCard):
   - Увеличен размер шрифта и элементов без изменения общей высоты карточки
   - Кнопка удаления перемещена в правый верхний угол карточки
   - Блок кнопок управления перенесен вниз карточки для улучшения эргономики
   - Реализованы кнопки остановки/возобновления и просмотра изменений с использованием иконок
   - Увеличена высота прогресс-бара для лучшей видимости

## Улучшения интерфейса (14.05.2025 - 15.05.2025)

### Улучшенный компонент TaskCard

1. **Увеличены размеры элементов**:
   - Увеличен размер шрифта заголовка и текста
   - Увеличены размеры иконок и кнопок
   - Увеличены отступы между элементами для лучшего визуального разделения

2. **Добавлены новые кнопки управления**:
   - Кнопка редактирования задачи (синяя) – позволяет изменить настройки задачи
   - Кнопка мгновенного обновления (оранжевая) – позволяет немедленно проверить изменения
   - Все кнопки теперь имеют всплывающие подсказки (tooltips)

3. **Улучшенная визуальная иерархия**:
   - Увеличена высота прогресс-бара для лучшей видимости
   - Больший контраст между элементами интерфейса
   - Улучшенные иконки с лучшей видимостью

4. **Использование централизованных констант**:
   - Все цвета теперь используются из файла констант
   - Интервалы и другие настройки также используются из файла констант

### Страница настроек

Добавлена новая страница настроек с следующими разделами:

1. **Основные настройки**:
   - Выбор языка интерфейса (в текущей версии поддерживаются английский и русский)
   - Выбор интервала проверки по умолчанию (15 мин, 1 час, 3 часа, 1 день)
   - Установка максимального количества задач (от 1 до 20)

2. **Настройки уведомлений**:
   - Включение/выключение всплывающих уведомлений при обнаружении изменений
   - Включение/выключение счетчика на иконке расширения
   - Автоматическое возобновление отслеживания при запуске браузера

3. **Управление данными**:
   - Экспорт всех данных (задачи и настройки) в JSON-файл
   - Импорт данных из файла экспорта
   - Сброс настроек до значений по умолчанию
   - Полная очистка всех данных расширения

### Файл констант

Создан новый файл констант для централизованного управления настройками:

1. **Цветовая схема**:
   - Цвета для разных статусов задач (изменено, без изменений, приостановлено)
   - Цвета для кнопок и других элементов интерфейса
   - Цвета для фонов и границ

2. **Интервалы проверки**:
   - Структурированные данные о доступных интервалах проверки
   - Метки и их значения в миллисекундах

3. **Основные настройки**:
   - Максимальное количество задач
   - Список доступных языков
   - Настройки по умолчанию

## Инструкции по сборке и установке

### Требования
- Node.js 20.x LTS
- pnpm (рекомендуется для управления зависимостями)
- Google Chrome или браузер на основе Chromium

### Сборка расширения

Для сборки расширения используйте универсальный скрипт `build.sh`:

```bash
# Сделать скрипт исполняемым
chmod +x build.sh

# Сборка продуктивной версии (по умолчанию)
./build.sh

# Сборка в режиме разработки
./build.sh dev

# Сборка в режиме отладки
./build.sh debug
```

Скрипт выполнит следующие действия:
1. Проверит наличие всех необходимых инструментов и зависимостей
2. Проверит структуру проекта
3. Проверит CSP-совместимость кода
4. Выполнит сборку проекта
5. Внесет необходимые исправления в manifest.json
6. Создаст ZIP-архив расширения (в режиме production)
7. Выведет инструкции по установке

### Дополнительные скрипты

```bash
# Создание резервной копии проекта
chmod +x backup.sh
./backup.sh

# Очистка временных файлов
chmod +x clear.sh
./clear.sh
```

### Установка расширения

1. Откройте chrome://extensions/
2. Включите режим разработчика (переключатель в правом верхнем углу)
3. Нажмите 'Загрузить распакованное расширение'
4. Выберите папку dist
5. После установки рекомендуется перезапустить браузер

## Проблемы и их решения

### 1. Проблема с CSP и Manifest V3

**Проблема:** Manifest V3 в Chrome вводит строгие ограничения Content Security Policy (CSP), запрещающие использование `unsafe-eval`. Vue.js и многие другие фреймворки используют `eval()` или `new Function()` для компиляции шаблонов и других функций, что приводит к ошибкам:

```
EvalError: Refused to evaluate a string as JavaScript because 'unsafe-eval' is not an allowed source of script in the following Content Security Policy directive: "script-src 'self'".
```

**Решение:**

1. **Переработка Vue-компонентов:**
   - Компоненты переписаны с использованием `defineComponent` и без динамической компиляции шаблонов
   - Шаблоны определены в самих компонентах, а не компилируются динамически
   - Используется упрощенный подход к реактивности

2. **Ручная интернационализация:**
   - Вместо Vue I18n (который использует eval), создана простая функция перевода:
   ```javascript
   const t = (key) => {
     const langMessages = messages[userLang] || messages.en;
     const keys = key.split('.');
     let result = langMessages;
     for (const k of keys) {
       if (result && typeof result === 'object' && k in result) {
         result = result[k];
       } else {
         return key;
       }
     }
     return typeof result === 'string' ? result : key;
   };
   ```

3. **Оптимизация manifest.json:**
   - Удаление `unsafe-eval` из CSP:
   ```json
   "content_security_policy": {
     "extension_pages": "script-src 'self'; object-src 'self'; style-src 'self' 'unsafe-inline';"
   }
   ```

4. **Глобальный доступ к роутеру:**
   - Роутер доступен через `window.vueRouter` для упрощения доступа между компонентами:
   ```javascript
   const router = window.vueRouter;
   ```

### 2. Проблема с минификацией Terser

**Проблема:** При сборке возникала ошибка с Terser, который является опциональной зависимостью в Vite v3+:

```
[vite:terser] terser not found. Since Vite v3, terser has become an optional dependency. You need to install it.
```

**Решение:**
- Добавлена автоматическая установка Terser в скрипт сборки
- Реализована проверка наличия Terser перед сборкой
- Если Terser не установлен, используется esbuild для минификации

### 3. Проблема с хранением задач

**Проблема:** При загрузке задач из Chrome Storage API возникали проблемы с undefined, и задачи не отображались.

**Решение:**
- Реализовано прямое обращение к Chrome Storage API в компонентах
- Добавлена подробная обработка ошибок и фолбэк на демо-данные
- Добавлено логирование для отладки:
```javascript
try {
  const result = await browser.storage.local.get('tasks');
  if (result.tasks && Array.isArray(result.tasks)) {
    tasks.value = result.tasks;
  } else {
    tasks.value = generateDemoTasks();
  }
} catch (err) {
  console.error('Error loading tasks:', err);
  tasks.value = generateDemoTasks();
}
```

### 4. Проблема с интернационализацией на странице настроек

**Проблема:** При переходе на страницу настроек возникала ошибка: "Cannot read properties of undefined (reading 't')", связанная с доступом к функции перевода, которая еще не была инициализирована.

**Решение:**
1. **Изменение порядка инициализации:**
   ```javascript
   // Создаем функцию перевода
   const t = (key) => { /* логика перевода */ }
   
   // Добавляем её в window ДО создания приложения
   window.t = t
   
   // Создаем приложение
   const app = createApp(AppComponent)
   
   // И только потом монтируем приложение
   app.mount('#app')
   ```

2. **Создание вспомогательного модуля с запасным решением:**
   ```javascript
   // utils/i18n-helper.ts
   export function translate(key) {
     // Попытка использовать глобальную функцию
     if (window.t && typeof window.t === 'function') {
       return window.t(key)
     }
     
     // Запасная логика, если глобальная функция недоступна
     // ...внутренняя реализация...
   }
   ```

3. **Замена прямых вызовов в шаблоне компонента:**
   ```html
   <!-- Было -->
   <h1>{{ window.t('options.title') }}</h1>
   
   <!-- Стало -->
   <h1>{{ translate('options.title') }}</h1>
   ```

### 5. Проблема с CSP и inline-скриптами

**Проблема:** Manifest V3 запрещает использование inline-скриптов, что приводит к ошибкам CSP:

```
Refused to execute inline script because it violates the following Content Security Policy directive: "script-src 'self'".
```

**Решение:**
- Удалены все inline-скрипты из HTML-файлов
- Все JavaScript-код перемещен во внешние файлы
- В файле options/index.html удалены скрипты для логирования, которые нарушали CSP
- Дополнительное логирование реализовано в main.ts с защитой от ошибок

### 6. Проблема с ошибкой "n.filter is not a function"

**Проблема:** В коде возникала ошибка при попытке вызвать метод `filter` на переменной, которая не является массивом:

```
Uncaught (in promise) TypeError: n.filter is not a function
```

**Решение:**
- Добавлена защита от ошибок в функции перевода с типизацией переменных
- Улучшена обработка ошибок в основных файлах проекта
- Добавлены проверки на тип перед вызовом методов массива
- Улучшена диагностика с дополнительным логированием

## Технические детали реализации

### Структура проекта

```
src/
├── assets/            # Глобальные ресурсы (иконки, стили)
├── background/        # Фоновые скрипты (service worker)
├── components/        # Общие Vue компоненты
├── content-script/    # Скрипты для выполнения на веб-страницах
├── locales/           # Файлы локализации (i18n)
├── stores/            # Хранилища Pinia
├── types/             # TypeScript типы
├── ui/                # Пользовательские интерфейсы
│   ├── popup/         # Всплывающее окно расширения
│   │   ├── pages/     # Страницы для попапа
│   │   └── router/    # Маршрутизация попапа
│   └── options/       # Страница настроек
└── utils/             # Утилиты и вспомогательные функции
    ├── constants/     # Константы проекта (цвета, настройки)
    └── i18n-helper.ts # Вспомогательные функции для интернационализации
```

### Ключевые технологии и подходы

1. **Vue 3 с CSP-совместимостью:**
   - Использование `defineComponent` для статической компиляции
   - Отказ от динамической компиляции шаблонов
   - Простая система i18n без использования eval()
   - Строгое соблюдение ограничений CSP в Manifest V3

2. **Tailwind CSS для стилизации:**
   - Утилитарный подход к CSS
   - Цветовая схема согласно ТЗ
   - Адаптивный дизайн

3. **Chrome Storage API:**
   - Хранение задач и настроек
   - Обработка ошибок и восстановление данных
   - Демо-режим для отображения примера работы

4. **Manifest V3:**
   - Строгая политика CSP без unsafe-eval и unsafe-inline
   - Использование service worker для background скриптов
   - Минимальные необходимые разрешения

5. **Интеграция с веб-страницами:**
   - Content-скрипты для взаимодействия с DOM
   - Селекторы элементов для отслеживания
   - Обнаружение изменений в элементах

## Особенности работы с Manifest V3

Manifest V3 вводит ряд ограничений для расширений Chrome, в том числе:

1. Запрет на использование `unsafe-eval` в CSP, что затрудняет работу с фреймворками, использующими динамическую компиляцию кода.
2. Запрет на использование `unsafe-inline` для скриптов, что требует перемещения всего JavaScript-кода во внешние файлы.
3. Замена background-страниц на service workers, имеющие ограниченный жизненный цикл.
4. Более строгие ограничения на доступ к API.

В проекте Web Check все эти ограничения были учтены и реализованы соответствующие решения:

1. Компоненты Vue переписаны для работы без eval() и new Function().
2. Разработана собственная система локализации без динамической компиляции.
3. Удалены все inline-скрипты из HTML-файлов.
4. Service worker оптимизирован для быстрого старта и корректной работы.
5. Вместо устаревших API используются современные аналоги, совместимые с MV3.

## Дальнейшие шаги разработки

- Реализовать полноценную функциональность выбора элементов на странице
- Добавить функциональность создания новых задач отслеживания
- Расширить систему уведомлений
- Добавить дополнительные настройки расширения
- Расширить список поддерживаемых языков
- Добавить интеграционные и юнит-тесты
- Создать единый модуль i18n для повторного использования во всех компонентах
- Улучшить обработку ошибок и диагностику проблем

## Полезные материалы по Manifest V3 и CSP

1. [Chrome Developer Documentation - Manifest V3](https://developer.chrome.com/docs/extensions/mv3/intro/)
2. [Content Security Policy for Extensions](https://developer.chrome.com/docs/extensions/mv3/manifest/content_security_policy/)
3. [Migrating from Vue 2 to Vue 3](https://v3-migration.vuejs.org/)
4. [CSP-совместимый Vue.js](https://vuejs.org/guide/best-practices/security.html#potential-dangers)
5. [Chrome Extensions API Reference](https://developer.chrome.com/docs/extensions/reference/)