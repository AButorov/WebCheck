# Web Check - расширение для отслеживания изменений на сайтах

## Обзор проекта

Web Check - интуитивно понятное расширение для браузера Google Chrome, позволяющее пользователям отслеживать изменения на конкретных элементах веб-страниц. Пользователи могут добавлять элементы для мониторинга, выбирать интервал проверки и получать уведомления при обнаружении изменений.

## Статус разработки (20.05.2025, последнее обновление 19:00)

- [x] Создана базовая структура проекта на основе vite-vue3-browser-extension-v3
- [x] Настроены основные конфигурационные файлы (package.json, vite.config.ts, tsconfig.json)
- [x] Настроен Tailwind CSS согласно требованиям ТЗ
- [x] Созданы файлы локализации (en, ru)
- [x] Создан интерфейс управления задачами согласно ТЗ
- [x] Реализовано хранилище задач с использованием Pinia и Chrome Storage API
- [x] Созданы базовые скрипты (background, content-script)
- [x] Реализован базовый механизм проверки изменений
- [x] Реализовано отображение изменений в формате "было/стало"
- [x] Создан универсальный скрипт для сборки CSP-совместимой версии
- [x] Реализована поддержка строгой политики CSP в Manifest V3
- [x] Переработаны Vue-компоненты для работы без использования eval()
- [x] Решены проблемы с CSP-совместимостью в Manifest V3
- [x] Реализована ручная интернационализация без использования eval()
- [x] Улучшена обработка ошибок и логирование для отладки
- [x] Улучшен интерфейс управления задачами - более компактный и информативный
- [x] Добавлены новые кнопки управления задачами с иконками
- [x] Реализована цветовая схема согласно техническому заданию
- [x] Создан файл констант для удобного управления цветами и другими общими настройками
- [x] Создана страница настроек расширения
- [x] Оптимизирована система скриптов сборки
- [x] Исправлена ошибка инициализации i18n на странице настроек
- [x] Исправлены ошибки CSP и типизации в коде
- [x] Оптимизирован интерфейс попап-окна и карточек задач
- [x] Разработан надежный механизм выбора элементов на странице
- [x] Oптимизированы Скрипты под zsh
- [x] Реализована архитектура фонового мониторинга для отслеживания изменений

## Выполненные работы (20.05.2025 - исправление системы мониторинга, 19:00)

1. Исправлены ошибки в системе мониторинга:
   - Добавлена проверка типа задач, исправлена ошибка `TypeError: e.filter is not a function`
   - Добавлен новый интервал проверки - 10 секунд для отладки
   - Исправлена проблема с пустыми белыми иконками бейджа
   - Улучшен SVG формат иконок с добавлением белого фона

2. Исправлена проблема с потерей задач между сеансами:
   - Добавлена проверка целостности данных в хранилище
   - Реализована фильтрация невалидных задач при загрузке
   - Добавлено обязательное сохранение данных в Chrome Storage API при загрузке

3. Добавлены улучшения для отладки:
   - Добавлен новый интервал проверки '10s' в форме редактора задач
   - Расширено логирование на стороне хранилища задач
   - Добавлены дополнительные проверки и обработка ошибок в модуле мониторинга

## Выполненные работы (20.05.2025 - оптимизация скрипта сборки, 18:00)

1. Обновлен скрипт сборки для поддержки современных версий ImageMagick:
   - Добавлена поддержка ImageMagick v7+ с командой `magick`
   - Реализовано автоматическое определение подходящей команды для конвертации изображений
   - Сохранена обратная совместимость с более старыми версиями с командой `convert`
   - Устранены предупреждения об устаревшей команде при использовании современной версии ImageMagick

## Выполненные работы (20.05.2025 - фундаментальный фикс иконок бейджа, 17:30)

1. Радикально улучшена система генерации иконок бейджа:
   - Вместо копирования исходных иконок используется программная генерация SVG иконок
   - Добавлена автоматическая конвертация SVG в PNG с помощью ImageMagick (если установлен)
   - Реализована фальбэк для использования SVG, если ImageMagick недоступен
   - Устранена проблема с декодированием изображений

2. Улучшен скрипт сборки:
   - Добавлена функция `create_icon` для генерации иконок на лету
   - Иконки генерируются в двух цветовых вариантах: синий (обычный) и желтый (для состояния с изменениями)
   - Реализована полная независимость от дефектных исходных иконок

## Выполненные работы (20.05.2025 - исправление ошибки с иконками бейджа, 16:30)

1. Исправлена ошибка отображения иконок бейджа:
   - Исправлены пути к иконкам в файле `badge.ts` — удалён префикс `assets/`
   - Добавлено автоматическое создание иконок для изменённого состояния (16px, 32px, 128px)
   - Улучшен скрипт сборки для проверки и копирования всех необходимых иконок
   - Добавлена проверка наличия иконок изменённого состояния в процессе сборки

2. Улучшен скрипт сборки:
   - Добавлена обработка всех размеров иконок (16, 32, 48, 128px)
   - Реализовано автоматическое копирование иконок изменённого состояния
   - Добавлены информативные сообщения о статусе обработки иконок

## Выполненные работы (20.05.2025 - реализация фонового мониторинга, 15:00)

1. Реализована архитектура фонового мониторинга:
   - Создан модуль `monitor` для централизованного управления мониторингом
   - Реализован механизм планирования проверок с использованием Chrome Alarms API
   - Добавлен механизм проверки элементов с использованием chrome.scripting API
   - Разработана система очередей для оптимизации одновременных проверок

2. Улучшена визуальная обратная связь:
   - Реализовано обновление бейджа расширения со счетчиком изменений
   - Добавлены специальные иконки для состояния с изменениями
   - Улучшен интерфейс отображения времени до следующей проверки

3. Расширена модель данных задач мониторинга:
   - Добавлены новые поля для отслеживания истории проверок
   - Реализована более надежная обработка ошибок
   - Добавлена информация о следующей запланированной проверке

4. Оптимизировано использование ресурсов:
   - Реализован механизм регулирования числа одновременных проверок
   - Добавлена проверка активности задач перед планированием
   - Улучшена обработка восстановления после перезапуска браузера

5. Улучшена система уведомлений:
   - Реализованы браузерные уведомления при обнаружении изменений
   - Добавлена возможность перехода к изменениям при клике на уведомление
   - Реализовано автоматическое закрытие уведомлений по таймауту

## Выполненные работы (18.05.2025 - улучшение формы редактирования задачи, 14:00)

1. Улучшена форма редактирования задачи:

   - Удален заголовок "Новая задача", избегая дублирования с заголовком попапа
   - Изменен порядок блоков: поле ввода названия задачи перемещено выше блока с выбранным элементом
   - Добавлено автоматическое установление фокуса на поле ввода названия задачи
   - Реализовано автоматическое выделение текста в поле ввода названия задачи при открытии формы

2. Улучшен пользовательский опыт:

   - Форма редактирования стала более логичной и понятной для пользователя
   - Уменьшено визуальное дублирование информации
   - Пользователь может сразу приступить к редактированию названия без необходимости вручную устанавливать фокус

3. Добавлено новое поведение интерфейса:
   - Автоматическое фокусирование и выделение текста для быстрого редактирования
   - Использование ref для прямого доступа к инпуту
   - Добавлена небольшая задержка для гарантии полной загрузки DOM и корректной работы фокуса

## Выполненные работы (18.05.2025 - исправление проблемы с захватом элементов, 01:00)

1. Исправлена проблема с захватом элементов на странице:

   - Изменен порядок действий в функции activateElementSelection – теперь сначала отправляется сообщение, и только потом закрывается popup-окно
   - Добавлены дополнительные проверки и задержки для гарантированной активации вкладки
   - Добавлен механизм проверки успешности инжекции скрипта выбора элемента

2. Улучшено взаимодействие между компонентами расширения:

   - Добавлен обработчик сообщений в content script для проверки активности селектора
   - Реализована дополнительная проверка активности селектора после инжекции
   - В фоновом скрипте добавлены дополнительные проверки для обеспечения работы с разными типами вкладок

3. Добавлены улучшения для обработки ошибок:
   - Добавлены уведомления браузера в случае ошибки инжекции скрипта
   - Реализована обработка исключений и восстановление после ошибок активации выбора элемента

## Выполненные работы (17.05.2025 - исправлена ошибка при загрузке расширения, 16:00)

1. Исправлена ошибка `Permission '<all_urls>' is unknown` при загрузке расширения:
   - Перемещено разрешение `<all_urls>` из `permissions` в `host_permissions`
   - Обновлен скрипт build.sh с учетом правильного размещения разрешений
   - Добавлена отдельная проверка `activeTab` и `<all_urls>` в соответствующих разделах манифеста
   - Обеспечена полная совместимость с Manifest V3

## Выполненные работы (17.05.2025 - исправлена ошибка разрешений, 15:00)

1. Исправлена ошибка при захвате элемента "Either the '<all_urls>' or 'activeTab' permission is required":
   - Добавлено разрешение `<all_urls>` в manifest.ts
   - Обновлен скрипт build.sh для автоматического добавления необходимых разрешений
   - Обеспечена полная совместимость с Manifest V3
   - Добавлена проверка наличия необходимых разрешений при сборке

## Выполненные работы (17.05.2025 - исправлено закрытие редактора задач, 14:00)

1. Исправлена проблема с автоматическим закрытием редактора задач после выбора элемента:
   - Добавлена функция "тихой очистки" для выборщика элементов, которая не отправляет сообщение об отмене
   - Изменена логика завершения работы выборщика элементов после успешного выбора
   - Теперь редактор задач остается открытым после выбора элемента
   - Полный процесс создания задачи теперь работает корректно

## Выполненные работы (17.05.2025 - улучшена обработка сообщений, 13:00)

1. Улучшена обработка сообщений между компонентами расширения:
   - Добавлен механизм проверки доступности получателя перед отправкой сообщений
   - Реализован система ping-pong для проверки активности компонентов
   - Улучшена обработка ошибок при отправке сообщений
   - Устранены ошибки "Could not establish connection. Receiving end does not exist"

## Выполненные работы (17.05.2025 - исправление обработки выбранного элемента, 12:00)

1. Исправлена ошибка в background script при обработке выбранного элемента:
   - Удалены использования DOM API в Service Worker контексте
   - Изменен механизм обработки изображений для совместимости с Manifest V3
   - Улучшена обработка ошибок и логирование
   - Теперь полностью работает процесс создания новой задачи

## Выполненные работы (17.05.2025 - полное исправление файла element-selector.js, 11:30)

1. Полностью пересоздан файл element-selector.js:
   - Устранена синтаксическая ошибка в функции handleClick
   - Полностью восстановлена работоспособность механизма выбора элементов
   - Добавлено дополнительное логирование для отладки
   - Улучшена обратная связь при выборе элементов

## Выполненные работы (17.05.2025 - исправлена синтаксическая ошибка, 11:00)

1. Исправлена синтаксическая ошибка в element-selector.js:
   - Добавлена отсутствующая закрывающая скобка в функции handleClick
   - Восстановлена работоспособность механизма выбора элементов
   - Интерфейс выбора элементов теперь корректно отображается на странице

## Выполненные работы (17.05.2025 - исправлена ошибка выбора элементов, 10:00)

1. Исправлена критическая ошибка в механизме выбора элементов:
   - Исправлена синтаксическая ошибка в обработчике клика
   - Добавлена небольшая задержка при выборе элемента для стабильности
   - Улучшена визуальная обратная связь при выборе элемента
   - Добавлено дополнительное логирование для отладки

## Выполненные работы (16.05.2025 - полная переработка выбора элементов, 21:30)

1. Полностью переработан механизм выбора элементов:
   - Создан новый простой, надёжный и самодостаточный скрипт element-selector.js
   - Реализован прямой подход к инжекции скрипта через chrome.scripting.executeScript
   - Добавлена информационная панель внизу страницы вместо оверлея на весь экран
   - Улучшена визуальная обратная связь при выборе элементов
2. Оптимизирована архитектура взаимодействия компонентов:
   - Упрощена модель коммуникации между popup, background и content script
   - Добавлены глобальные переменные для отслеживания состояния выбора элементов
   - Реализована защита от множественной активации и повторного инжекта скрипта
   - Добавлены обработчики отмены выбора через Escape и кнопку "Отменить"
3. Улучшена обработка генерации селекторов:
   - Реализованы 3 уровня генерации селекторов (по ID, по классам, по структуре DOM)
   - Добавлена проверка уникальности селекторов на странице
   - Добавлена поддержка nth-child для более точного выбора элементов
4. Улучшена обработка ошибок:
   - Добавлено детальное логирование на всех этапах выбора элемента
   - Реализована защита от возможных ошибок при обработке событий
   - Добавлена функция очистки ресурсов (cleanup) при отмене или завершении выбора
5. Оптимизирован весь процесс выбора элемента:
   - Упрощена модель данных для передачи между компонентами
   - Улучшена визуализация выбранного элемента с более заметными стилями
   - Добавлена информация о текущем элементе в панели внизу страницы

## Выполненные работы (14.05.2025 - 16.05.2025)

1. Создана основная структура расширения с использованием Vue 3, TypeScript и Vite
2. Реализован механизм хранения данных в Chrome Storage API
3. Создан интерфейс управления задачами согласно требованиям ТЗ
4. Разработан механизм проверки изменений на веб-страницах
5. Реализован компонент TaskCard для отображения информации о задачах
6. Создана страница просмотра изменений в формате "было/стало"
7. Решены проблемы с CSP-совместимостью в Manifest V3
8. Создан универсальный скрипт сборки с проверками и исправлениями
9. Улучшен интерфейс управления задачами
10. Оптимизирована система скриптов для упрощения процесса разработки
11. Исправлены ошибки CSP и типизации в коде
12. Разработан надежный механизм выбора элемента для отслеживания на странице

## Инструкции по сборке и установке

### Требования

- Node.js 20.x LTS
- pnpm (рекомендуется для управления зависимостями)
- Google Chrome или браузер на основе Chromium

### Сборка расширения

Для сборки расширения используйте универсальный скрипт `build.sh`:

```zsh
# Сборка продуктивной версии (по умолчанию)
./build.sh

# Сборка в режиме разработки
./build.sh dev

# Сборка в режиме отладки
./build.sh debug
```

Скрипт выполнит следующие действия:

1. Проверит наличие всех необходимых инструментов и зависимостей
2. Проверит структуру проекта
3. Проверит CSP-совместимость кода
4. Выполнит сборку проекта
5. Внесет необходимые исправления в manifest.json
6. Создаст ZIP-архив расширения (в режиме production)
7. Выведет инструкции по установке

### Дополнительные скрипты

```zsh
# Создание резервной копии проекта
./backup.sh

# Очистка временных файлов
./clear.sh
```

### Установка расширения

1. Откройте chrome://extensions/
2. Включите режим разработчика (переключатель в правом верхнем углу)
3. Нажмите 'Загрузить распакованное расширение'
4. Выберите папку dist
5. После установки рекомендуется перезапустить браузер

## Проблемы и их решения

### 1. Проблема с CSP и Manifest V3

**Проблема:** Manifest V3 в Chrome вводит строгие ограничения Content Security Policy (CSP), запрещающие использование `unsafe-eval`. Vue.js и многие другие фреймворки используют `eval()` или `new Function()` для компиляции шаблонов и других функций, что приводит к ошибкам.

**Решение:**

- Переработаны Vue-компоненты с использованием `defineComponent` и без динамической компиляции шаблонов
- Создана простая функция интернационализации без использования eval()
- Удалено `unsafe-eval` из настроек CSP в manifest.json
- Роутер доступен через `window.vueRouter` для упрощения доступа между компонентами

### 2. Проблема с хранением задач

**Проблема:** При загрузке задач из Chrome Storage API возникали проблемы с undefined, и задачи не отображались.

**Решение:**

- Реализовано прямое обращение к Chrome Storage API в компонентах
- Добавлена подробная обработка ошибок и фолбэк на демо-данные
- Добавлено логирование для отладки

### 3. Проблема с интернационализацией на странице настроек

**Проблема:** При переходе на страницу настроек возникала ошибка связанная с доступом к функции перевода.

**Решение:**

- Изменен порядок инициализации функции перевода
- Создан вспомогательный модуль с запасным решением
- Заменены прямые вызовы в шаблоне компонента

### 4. Проблема с выбором элемента на странице

**Проблема:** При попытке выбора элемента на странице возникала ошибка "Could not establish connection. Receiving end does not exist." и элементы не выделялись. Также появлялась ошибка "Either the '<all_urls>' or 'activeTab' permission is required" при попытке захвата элемента. При попытке загрузки расширения возникала ошибка "Permission '<all_urls>' is unknown".

**Решение:**

- Полностью переработан механизм выбора элементов с использованием самодостаточного скрипта
- Реализована упрощенная модель коммуникации между компонентами
- Применен прямой подход к инжекции скрипта через chrome.scripting.executeScript
- Добавлена информационная панель внизу страницы для обратной связи
- Добавлено разрешение `<all_urls>` в `host_permissions` и сохранено `activeTab` в `permissions`
- Реализована более надежная система обработки событий и защита от ошибок
- Улучшена генерация селекторов для более точного определения элементов на странице

### 5. Проблема с фоновым мониторингом

**Проблема:** Фоновый мониторинг требовал проверки веб-страниц в скрытом режиме, что вызывало проблемы с производительностью и безопасностью.

**Решение:**
- Реализован механизм создания скрытых вкладок для проверки с минимальным потреблением ресурсов
- Добавлена система очередей для ограничения одновременных проверок
- Использован chrome.scripting API для безопасного выполнения кода на страницах
- Реализована защита от возможных ошибок при инжекции скриптов
- Добавлена автоматическая очистка ресурсов (закрытие вкладок) после проверки

## Технические детали реализации

### Структура проекта

```
src/
├── assets/            # Глобальные ресурсы (иконки, стили)
├── background/        # Фоновые скрипты (service worker)
│   ├── capture/       # Модуль для создания скриншотов элементов
│   └── monitor/       # Модуль системы фонового мониторинга
├── components/        # Общие Vue компоненты
├── content-script/    # Скрипты для выполнения на веб-страницах
│   └── element-selector.js # Новый скрипт выбора элементов
├── locales/           # Файлы локализации (i18n)
├── stores/            # Хранилища Pinia
├── types/             # TypeScript типы
├── ui/                # Пользовательские интерфейсы
│   ├── popup/         # Всплывающее окно расширения
│   │   ├── pages/     # Страницы для попапа
│   │   └── router/    # Маршрутизация попапа
│   └── options/       # Страница настроек
└── utils/             # Утилиты и вспомогательные функции
    ├── constants/     # Константы проекта (цвета, настройки)
    └── i18n-helper.ts # Вспомогательные функции для интернационализации
```

### Ключевые технологии и подходы

1. **Vue 3 с CSP-совместимостью:**

   - Использование `defineComponent` для статической компиляции
   - Отказ от динамической компиляции шаблонов
   - Простая система i18n без использования eval()
   - Строгое соблюдение ограничений CSP в Manifest V3

2. **Tailwind CSS для стилизации:**

   - Утилитарный подход к CSS
   - Цветовая схема согласно ТЗ
   - Адаптивный дизайн

3. **Chrome Storage API:**

   - Хранение задач и настроек
   - Обработка ошибок и восстановление данных
   - Демо-режим для отображения примера работы

4. **Manifest V3:**

   - Строгая политика CSP без unsafe-eval и unsafe-inline
   - Использование service worker для background скриптов
   - Использование chrome.scripting.executeScript для инжекции скриптов
   - Минимальные необходимые разрешения

5. **Интеграция с веб-страницами:**
   - Content-скрипты для взаимодействия с DOM
   - Селекторы элементов для отслеживания
   - Обнаружение изменений в элементах

## Архитектура системы фонового мониторинга

Новая система фонового мониторинга построена с учетом требований производительности, надежности и экономии ресурсов:

1. **Модульная архитектура:**
   - Основной модуль `monitor/index.ts` для управления задачами
   - Модуль `element-checker.ts` для проверки элементов на веб-страницах
   - Модуль `badge.ts` для управления значком расширения

2. **Планирование проверок:**
   - Использование chrome.alarms API для эффективного планирования
   - Проверка задач каждую минуту с фильтрацией по истечению интервала
   - Автоматическое возобновление при запуске браузера

3. **Оптимизация ресурсов:**
   - Система очередей для ограничения одновременных проверок
   - Создание временных скрытых вкладок для проверки контента
   - Автоматическое закрытие всех временных ресурсов

4. **Уведомления и обратная связь:**
   - Обновление значка расширения со счетчиком изменений
   - Системные уведомления браузера при обнаружении изменений
   - Прогресс-бар для визуализации времени до следующей проверки

5. **Надежность:**
   - Восстановление состояния после перезагрузки браузера
   - Подробное логирование для отладки
   - Обработка ошибок на всех этапах проверки
