(function(){var y=Object.defineProperty;var s=(d,m)=>y(d,"name",{value:m,configurable:!0});(function(){if(window.webCheckContentScriptLoaded){console.log("[WebCheck:ContentScript] Content script already loaded, skipping initialization");return}window.webCheckContentScriptLoaded=!0,console.log("[WebCheck:ContentScript] Content script loaded and ready"),window.webCheckReadyMessageSent||(window.webCheckReadyMessageSent=!0,setTimeout(()=>{try{typeof browser<"u"?browser.runtime.sendMessage({action:"contentScriptReady"}).catch(()=>{}):typeof chrome<"u"&&chrome.runtime.sendMessage({action:"contentScriptReady"})}catch{}},100));function d(){if(document.querySelector(".webcheck-overlay")){console.log("[WebCheck:ContentScript] Picker overlay already exists, not initializing again");return}console.log("[WebCheck:ContentScript] Activating element selector");let l=null,n=null;const e=document.createElement("div");e.className="webcheck-element-picker-active",e.style.position="absolute",e.style.border="2px solid #3e66fb",e.style.backgroundColor="rgba(62, 102, 251, 0.1)",e.style.pointerEvents="none",e.style.zIndex="10000",e.style.display="none",document.body.appendChild(e);const c=document.createElement("div");c.className="webcheck-element-picker-active",c.style.position="fixed",c.style.top="10px",c.style.left="50%",c.style.transform="translateX(-50%)",c.style.backgroundColor="#fff",c.style.border="1px solid #ddd",c.style.borderRadius="4px",c.style.padding="10px",c.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.1)",c.style.zIndex="10001",c.style.fontSize="14px",c.innerHTML='Кликните на элемент для отслеживания. <button id="webcheck-cancel-selection">Отмена</button>',document.body.appendChild(c);const g=document.getElementById("webcheck-cancel-selection");g&&g.addEventListener("click",function(i){i.preventDefault(),i.stopPropagation(),f()});function p(i){const r=document.elementFromPoint(i.clientX,i.clientY);if(!r||r===e||r===c||c.contains(r)||r.closest(".webcheck-element-picker-active")){e.style.display="none",n=null;return}n=r;const o=r.getBoundingClientRect();e.style.left=`${o.left+window.scrollX}px`,e.style.top=`${o.top+window.scrollY}px`,e.style.width=`${o.width}px`,e.style.height=`${o.height}px`,e.style.display="block"}s(p,"handleMouseMove");function h(i){if(i.preventDefault(),i.stopPropagation(),n&&!n.closest(".webcheck-element-picker-active")){l=n;const r=l.outerHTML,o=l.getBoundingClientRect(),a=b(l),C={selector:a,rect:{top:o.top+window.scrollY,left:o.left+window.scrollX,width:o.width,height:o.height,x:o.x,y:o.y,bottom:o.bottom,right:o.right},html:r,pageTitle:document.title,pageUrl:window.location.href,faviconUrl:k()};console.log("[WebCheck:ContentScript] Element selected:",a);try{(typeof browser<"u"?browser.runtime:chrome.runtime).sendMessage({action:"captureElement",elementInfo:C}),console.log("[WebCheck:ContentScript] Capture element message sent successfully")}catch(w){console.error("[WebCheck:ContentScript] Error sending capture message:",w)}f()}}s(h,"handleClick");function f(){document.removeEventListener("mousemove",p),document.removeEventListener("click",h),window.webCheckMouseMoveHandler=null,window.webCheckClickHandler=null,e.parentNode&&e.remove(),c.parentNode&&c.remove(),console.log("[WebCheck:ContentScript] Element selector cleaned up")}s(f,"cleanup");function k(){const i=document.querySelectorAll('link[rel*="icon"]');if(i.length>0){const r=i[i.length-1];if(r.href)return r.href}return new URL("/favicon.ico",window.location.origin).href}s(k,"getFaviconUrl");function b(i){if(i.id)return`#${i.id}`;let r="",o=i;for(;o!==document.body&&o.parentElement;){let a=o.tagName.toLowerCase();if(o.classList.length>0){const C=Array.from(o.classList).slice(0,2);a+=`.${C.join(".")}`}r=r?`${a} > ${r}`:a,o=o.parentElement}return r}s(b,"generateSelector"),window.webCheckMouseMoveHandler=p,window.webCheckClickHandler=h,document.addEventListener("mousemove",p),document.addEventListener("click",h),setTimeout(()=>{document.querySelector(".webcheck-element-picker-active")&&(console.log("[WebCheck:ContentScript] Auto-cleanup after 30 seconds"),f())},3e4)}s(d,"activateElementSelector");function m(t){let l=document.querySelector(t);if(!l){if(t.includes(".")){const n=t.split(".").pop()?.trim();if(n){const e=document.getElementsByClassName(n);e.length>0&&(l=e[0])}}else if(t.includes("#")){const n=t.split("#").pop()?.trim();if(n){const e=document.querySelectorAll(`[id*='${n}']`);e.length>0&&(l=e[0])}}if(!l&&t.match(/^[a-z]+(\.|\[)/i)){const n=t.match(/^[a-z]+/i)?.[0];if(n){const e=document.getElementsByTagName(n);e.length>0&&(l=e[0])}}}return l}s(m,"findElementBySelectorAdvanced");const u=typeof browser<"u"?browser.runtime:chrome.runtime;u.onMessage.addListener((t,l,n)=>{console.log("[WebCheck:ContentScript] Received message:",t.action||t.type);try{if(t.action==="ping")return console.log("[WebCheck:ContentScript] Ping received, sending pong"),n({status:"pong",timestamp:Date.now()}),!0;if(t.target==="content_script"&&t.type==="EXTRACT_CONTENT"){console.log("[WebCheck:ContentScript] Extract content request received:",t);try{const e=m(t.selector||"");if(e){const c=e.outerHTML;u.sendMessage({target:"offscreen",type:"CONTENT_EXTRACTED",requestId:t.requestId,content:c}),console.log("[WebCheck:ContentScript] Content extracted and sent to offscreen")}else u.sendMessage({target:"offscreen",type:"CONTENT_EXTRACTED",requestId:t.requestId,error:`Element not found with selector: ${t.selector}`}),console.warn("[WebCheck:ContentScript] Element not found:",t.selector)}catch(e){console.error("[WebCheck:ContentScript] Error extracting content:",e),u.sendMessage({target:"offscreen",type:"CONTENT_EXTRACTED",requestId:t.requestId,error:e instanceof Error?e.message:String(e)})}return!0}if(t.action==="activateElementSelection"){if(console.log("[WebCheck:ContentScript] Received activateElementSelection message, using built-in picker"),document.querySelector(".webcheck-element-picker-active"))return console.log("[WebCheck:ContentScript] Element picker already active"),n({status:"already_active"}),!0;try{d(),n({status:"activated",timestamp:Date.now()})}catch(e){console.error("[WebCheck:ContentScript] Error activating element selector:",e),n({status:"error",error:e instanceof Error?e.message:String(e)})}return!0}if(t.action==="activateElementPicker")return console.log("[WebCheck:ContentScript] Received activateElementPicker message, using built-in picker"),d(),n({status:"activated",method:"builtin_picker"}),!0;if(t.action==="cancelElementSelection")return console.log("[WebCheck:ContentScript] Received cancelElementSelection message"),document.querySelectorAll('.webcheck-element-picker-active, .webcheck-highlight, [id^="webcheck-"]').forEach(e=>e.remove()),window.webCheckMouseMoveHandler&&document.removeEventListener("mousemove",window.webCheckMouseMoveHandler),window.webCheckClickHandler&&document.removeEventListener("click",window.webCheckClickHandler),n({status:"cancelled"}),!0;console.log("[WebCheck:ContentScript] Unknown message action:",t.action||t.type),n({status:"unknown_action"})}catch(e){console.error("[WebCheck:ContentScript] Error processing message:",e),n({status:"error",error:e instanceof Error?e.message:String(e)})}}),console.log("[WebCheck:ContentScript] Core content script initialized without ES6 imports")})();
})()