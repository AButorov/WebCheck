var g=Object.defineProperty;var a=(e,t)=>g(e,"name",{value:t,configurable:!0});import{b as N}from"../assets/js/browser-polyfill.js";const E={MAX_CONCURRENT_REQUESTS:3,REQUEST_TIMEOUT:3e4,CONTENT_EXTRACTION_TIMEOUT:1e4,IFRAME_LOAD_TIMEOUT:15e3,MAX_CONTENT_SIZE:1024*1024},l=new Map;let u;console.log("[Offscreen] Offscreen document initialized");function d(){u=document.getElementById("offscreen-container")||document.body,console.log("[Offscreen] Iframe container initialized")}a(d,"initializeIframeContainer");N.runtime.onMessage.addListener((e,t,r)=>{if(console.log("[Offscreen] Получено сообщение:",e),e.target!=="offscreen")return!0;switch(e.type){case"EXTRACT_CONTENT":h(e).then(n=>{r({type:"CONTENT_EXTRACTED",requestId:e.requestId,content:n})}).catch(n=>{console.error("[Offscreen] Ошибка извлечения контента:",n),r({type:"CONTENT_EXTRACTED",requestId:e.requestId,error:n.message})});break;case"CANCEL_REQUEST":O(e.requestId),r({type:"REQUEST_CANCELLED",requestId:e.requestId});break;default:console.warn("[Offscreen] Неизвестный тип сообщения:",e.type),r({error:"Неизвестный тип сообщения"})}return!0});async function h(e){if(!e.url||!e.selector||!e.requestId)throw new Error("Отсутствуют обязательные параметры: url, selector, requestId");if(console.log(`[Offscreen] Начинаем извлечение контента с ${e.url}`),l.size>=E.MAX_CONCURRENT_REQUESTS)throw new Error(`Превышен лимит одновременных запросов (${E.MAX_CONCURRENT_REQUESTS})`);const t=I(e.url);try{await y(t);const r=await _(t,e.selector,e.requestId);return console.log(`[Offscreen] Контент успешно извлечен (${r.length} символов)`),r}finally{C(t,e.requestId)}}a(h,"handleContentExtractionRequest");function I(e){const t=document.createElement("iframe");return t.style.cssText=`
    position: absolute;
    left: -9999px;
    top: -9999px;
    width: 1024px;
    height: 768px;
    border: none;
    visibility: hidden;
  `,t.src=e,u||d(),u.appendChild(t),console.log(`[Offscreen] Iframe создан для ${e}`),t}a(I,"createIframe");function y(e){return new Promise((t,r)=>{const n=window.setTimeout(()=>{r(new Error("Таймаут загрузки iframe"))},E.IFRAME_LOAD_TIMEOUT),c=a(()=>{clearTimeout(n),e.removeEventListener("load",c),e.removeEventListener("error",o),console.log("[Offscreen] Iframe загружен успешно"),t()},"handleLoad"),o=a(()=>{clearTimeout(n),e.removeEventListener("load",c),e.removeEventListener("error",o),r(new Error("Ошибка загрузки iframe"))},"handleError");e.addEventListener("load",c),e.addEventListener("error",o),e.contentDocument?.readyState==="complete"&&c()})}a(y,"waitForIframeLoad");function p(e,t,r,n,c,o){console.log("[Offscreen] Используем postMessage для извлечения контента");const s=a(i=>{i.source===e.contentWindow&&i.data.type==="CONTENT_EXTRACTED"&&i.data.requestId===r&&(console.log("[Offscreen] Получен контент через postMessage"),clearTimeout(n),window.removeEventListener("message",s),i.data.error?o(new Error(i.data.error)):c(i.data.content||""))},"messageHandler");window.addEventListener("message",s);try{e.contentWindow?.postMessage({type:"EXTRACT_CONTENT",selector:t,requestId:r},"*")}catch(i){clearTimeout(n),window.removeEventListener("message",s),o(new Error(`Ошибка отправки сообщения в iframe: ${i}`))}}a(p,"extractContentViaPostMessage");function _(e,t,r){return new Promise((n,c)=>{const o=window.setTimeout(()=>{c(new Error("Таймаут извлечения контента"))},E.CONTENT_EXTRACTION_TIMEOUT);try{let s;try{s=e.contentDocument||e.contentWindow?.document||null}catch{return console.warn("[Offscreen] No direct access to iframe content, using postMessage"),p(e,t,r,o,n,c)}if(!s){clearTimeout(o),c(new Error("Не удалось получить доступ к документу iframe"));return}console.log("[Offscreen] Direct access to iframe document available"),s.readyState!=="complete"?(console.log("[Offscreen] Ожидаем полной загрузки документа в iframe"),s.addEventListener("readystatechange",()=>{s?.readyState==="complete"&&m(s,t,o,n,c)})):m(s,t,o,n,c)}catch(s){clearTimeout(o),c(new Error(`Ошибка при извлечении контента: ${s}`))}})}a(_,"extractContentFromIframe");function m(e,t,r,n,c){try{console.log(`[Offscreen] Ищем элемент по селектору: ${t}`);let o=null;try{o=e.querySelector(t)}catch(i){if(console.warn("[Offscreen] Ошибка селектора, пробуем альтернативные методы:",i),t.startsWith("#")){const f=t.substring(1);o=e.getElementById(f)}else if(t.startsWith(".")){const f=t.substring(1),T=e.getElementsByClassName(f);o=T.length>0?T[0]:null}else{const f=e.getElementsByTagName(t);o=f.length>0?f[0]:null}}if(clearTimeout(r),!o){c(new Error(`Элемент не найден по селектору: ${t}`));return}console.log("[Offscreen] Элемент найден, извлекаем контент");let s=o.outerHTML;s.length>E.MAX_CONTENT_SIZE&&(console.warn(`[Offscreen] Контент слишком большой (${s.length} символов), обрезаем`),s=s.substring(0,E.MAX_CONTENT_SIZE)+"...[TRUNCATED]"),console.log(`[Offscreen] Контент извлечен успешно (${s.length} символов)`),n(s)}catch(o){clearTimeout(r),c(new Error(`Ошибка при извлечении контента: ${o}`))}}a(m,"performContentExtraction");function O(e){const t=l.get(e);t&&(console.log(`[Offscreen] Отменяем запрос ${e}`),clearTimeout(t.timeoutId),C(t.iframe,e),t.reject(new Error("Запрос отменен")))}a(O,"handleCancelRequest");function C(e,t){try{const r=l.get(t);r&&(clearTimeout(r.timeoutId),l.delete(t)),e.parentNode&&e.parentNode.removeChild(e),console.log(`[Offscreen] Iframe для запроса ${t} очищен`)}catch(r){console.error("[Offscreen] Ошибка при очистке iframe:",r)}}a(C,"cleanupIframe");function w(){setInterval(()=>{const e=Date.now(),t=[];l.forEach((n,c)=>{e-parseInt(c.split("_")[1]||"0")>5*60*1e3&&t.push(c)}),t.forEach(n=>{console.log(`[Offscreen] Принудительная очистка старого запроса: ${n}`),O(n)});const r=u?.querySelectorAll("iframe")||[];r.length>l.size&&(console.log(`[Offscreen] Найдено ${r.length-l.size} потерянных iframe'ов`),Array.from(r).forEach(n=>{Array.from(l.values()).some(o=>o.iframe===n)||n.remove()}))},6e4)}a(w,"setupPeriodicCleanup");document.addEventListener("DOMContentLoaded",()=>{d(),w(),console.log("[Offscreen] Offscreen document готов к работе")});document.readyState==="loading"||(d(),w(),console.log("[Offscreen] Offscreen document готов к работе (immediate)"));
