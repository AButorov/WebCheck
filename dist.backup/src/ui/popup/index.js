var te=Object.defineProperty;var l=(e,t)=>te(e,"name",{value:t,configurable:!0});import{b as v}from"../../../assets/js/browser-polyfill.js";import{_ as I,d as U,c as f,o as c,a as se,r as ae,b as oe,e as D,f as s,n as L,g as P,t as h,w as H,v as F,h as W,i as ne,j as k,k as b,C as E,l as q,F as le,m as re,M as ie,p as G,q as de,s as ue,u as ce,x as ge,y as ve,z as fe,A as pe,B as me,D as we}from"../../../assets/js/ru.js";const ke=U({name:"App",setup(){const e=window.vueRouter;return oe((t,o,r)=>(console.error("[APP] Error captured:",t),console.error("[APP] Error info:",r),!1)),D(async()=>{console.log("[APP] App component mounted"),document.documentElement.classList.add("custom-scrollbar");try{const t=await v.storage.local.get(["openNewTaskEditor","newTaskData"]);t.openNewTaskEditor===!0&&t.newTaskData&&(console.log("[APP] Auto-redirecting to new task editor"),await v.storage.local.remove("openNewTaskEditor"),e&&e.push("/new-task"))}catch(t){console.error("[APP] Error checking for redirect flag:",t)}}),{}}}),be={class:"app-container"};function he(e,t,o,r,u,p){const n=ae("router-view");return c(),f("div",be,[se(n)])}l(he,"_sfc_render$5");const ye=I(ke,[["render",he]]),Te=U({name:"TaskCard",props:{task:{type:Object,required:!0,validator(e){return e&&typeof e.id=="string"&&typeof e.title=="string"&&typeof e.status=="string"&&typeof e.interval=="string"}}},emits:["update:interval","update:status","view","remove","edit","refresh"],setup(e,{emit:t}){if(!e.task||!e.task.id)return console.error("[TaskCard] Invalid task prop:",e.task),{interval:b("1h"),displayUrl:k(()=>""),checkboxClass:k(()=>"text-gray-500 border-gray-500"),cardClasses:k(()=>"bg-gray-100 border-gray-300"),progressClass:k(()=>"bg-gray-500"),remainingTimePercent:k(()=>0),remainingTimeText:k(()=>"Ошибка"),statusTitle:k(()=>"Ошибка в данных задачи"),onFaviconError:l(()=>{},"onFaviconError"),updateInterval:l(()=>{},"updateInterval"),toggleStatus:l(()=>{},"toggleStatus"),emit:t};const o=b(e.task.interval||"1h");function r(g){g.target.src="/icons/icon-16.png"}l(r,"onFaviconError");function u(){e.task&&e.task.id&&t("update:interval",e.task.id,o.value)}l(u,"updateInterval");const p=k(()=>{try{return new URL(e.task.url).hostname}catch{return e.task.url}}),n=k(()=>{switch(e.task.status){case"changed":return"Обнаружены изменения (нажмите чтобы приостановить)";case"unchanged":return"Активно (нажмите чтобы приостановить)";case"paused":return"Приостановлено (нажмите чтобы возобновить)";default:return"Неизвестный статус"}}),i=k(()=>{switch(e.task.status){case"changed":return"text-[#ffb300] border-[#ffb300]";case"unchanged":return"text-[#4caf50] border-[#4caf50]";case"paused":return"text-[#9e9e9e] border-[#9e9e9e]";default:return"text-gray-500 border-gray-500"}}),y=k(()=>{const g="task-card relative rounded-lg p-4 mb-4 border-2 transition-all hover:shadow-md";switch(e.task.status){case"changed":return`${g} bg-[#fff8e1] border-[#ffecb3]`;case"unchanged":return`${g} bg-[#f1f8e9] border-[#dcedc8]`;case"paused":return`${g} bg-[#f5f5f5] border-[#eeeeee]`;default:return`${g} bg-gray-100 border-gray-300`}}),N=k(()=>{switch(e.task.status){case"changed":return"bg-[#ffb300]";case"unchanged":return"bg-[#4caf50]";case"paused":return"bg-[#9e9e9e]";default:return"bg-gray-500"}}),T=k(()=>e.task.status==="paused"?0:A(e.task.lastCheckedAt,e.task.interval)),M=k(()=>e.task.status==="paused"?"Приостановлено":m(e.task.lastCheckedAt,e.task.interval));function A(g,S){const $=Date.now(),R=d(S),B=g+R,a=Math.max(0,B-$);return Math.floor(a/R*100)}l(A,"calculateTimeRemaining");function m(g,S){const $=Date.now(),R=d(S),B=g+R,a=Math.max(0,B-$);if(a<=0)return"Следующая проверка в ближайшее время";const w=Math.floor(a/(60*1e3)),C=Math.floor(w/60),ee=w%60;return C>0?`${C}ч ${ee}м`:`${w}м`}l(m,"formatRemainingTime");function d(g){switch(g){case"10s":return E.TEN_SECONDS.milliseconds;case E.FIFTEEN_MINUTES.value:return E.FIFTEEN_MINUTES.milliseconds;case E.ONE_HOUR.value:return E.ONE_HOUR.milliseconds;case E.THREE_HOURS.value:return E.THREE_HOURS.milliseconds;case E.ONE_DAY.value:return E.ONE_DAY.milliseconds;default:return E.ONE_HOUR.milliseconds}}l(d,"getIntervalMs");function x(){if(e.task&&e.task.id&&e.task.status){const g=e.task.status==="paused"?"unchanged":"paused";t("update:status",e.task.id,g)}}return l(x,"toggleStatus"),{interval:o,displayUrl:p,checkboxClass:i,cardClasses:y,progressClass:N,remainingTimePercent:T,remainingTimeText:M,statusTitle:n,onFaviconError:r,updateInterval:u,toggleStatus:x,emit:t}}}),xe={class:"flex items-start"},$e={class:"mr-2"},Ce=["title"],Ee={key:0,xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},Ne={class:"flex-grow mr-20"},Se=["title"],Me={class:"flex items-center text-base text-gray-600"},Ae=["src"],Re=["href","title"],ze={class:"absolute top-2 right-2"},Ie={class:"flex items-center mt-3"},Ue={class:"flex items-center text-sm mr-4"},Be=["disabled"],De={class:"flex-grow"},Ve={class:"bg-gray-200 rounded-full h-3"},Le={class:"text-sm text-gray-600 mt-1"},Pe={class:"flex space-x-2 mt-3 justify-end"},Oe=["title"],He={key:0,xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},je={key:1,xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"};function Fe(e,t,o,r,u,p){return c(),f("div",{class:L(e.cardClasses)},[s("div",xe,[s("div",$e,[s("button",{class:L([e.checkboxClass,"flex items-center justify-center w-7 h-7 border-2 rounded"]),title:e.statusTitle,onClick:t[0]||(t[0]=(...n)=>e.toggleStatus&&e.toggleStatus(...n))},[e.task.status!=="paused"?(c(),f("svg",Ee,t[8]||(t[8]=[s("path",{"fill-rule":"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z","clip-rule":"evenodd"},null,-1)]))):P("",!0)],10,Ce)]),s("div",Ne,[s("h3",{title:e.task.title,class:"text-xl font-bold mb-1 truncate max-w-[230px]"},h(e.task.title),9,Se),s("div",Me,[s("img",{src:e.task.faviconUrl||"/icons/icon-16.png",alt:"Site icon",class:"w-5 h-5 mr-1.5",onError:t[1]||(t[1]=(...n)=>e.onFaviconError&&e.onFaviconError(...n))},null,40,Ae),s("a",{href:e.task.url,title:e.task.url,target:"_blank",class:"hover:underline truncate max-w-[200px]"},h(e.displayUrl),9,Re)])]),s("div",ze,[s("button",{title:"Удалить задачу",class:"text-white bg-[#f44336] hover:bg-red-600 rounded-full p-1.5",onClick:t[2]||(t[2]=n=>e.emit("remove",e.task.id))},t[9]||(t[9]=[s("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[s("path",{"fill-rule":"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z","clip-rule":"evenodd"})],-1)]))])]),s("div",Ie,[s("div",Ue,[t[11]||(t[11]=s("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 mr-1.5 text-gray-600",viewBox:"0 0 20 20",fill:"currentColor"},[s("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z","clip-rule":"evenodd"})],-1)),H(s("select",{"onUpdate:modelValue":t[3]||(t[3]=n=>e.interval=n),disabled:e.task.status==="paused",class:"bg-transparent text-sm border border-gray-300 rounded px-2 py-0.5",onChange:t[4]||(t[4]=(...n)=>e.updateInterval&&e.updateInterval(...n))},t[10]||(t[10]=[W('<option value="10s"> 10с </option><option value="15m"> 15м </option><option value="1h"> 1ч </option><option value="3h"> 3ч </option><option value="1d"> 1д </option>',5)]),40,Be),[[F,e.interval]])]),s("div",De,[s("div",Ve,[s("div",{style:ne({width:e.remainingTimePercent+"%"}),class:L([e.progressClass,"h-3 rounded-full"])},null,6)]),s("div",Le,h(e.remainingTimeText),1)])]),s("div",Pe,[s("button",{class:L([e.task.status==="paused"?"bg-[#4caf50] hover:bg-green-600":"bg-[#ff9800] hover:bg-orange-600","text-white rounded-full p-2"]),title:e.task.status==="paused"?"Возобновить отслеживание":"Приостановить отслеживание",onClick:t[5]||(t[5]=(...n)=>e.toggleStatus&&e.toggleStatus(...n))},[e.task.status==="paused"?(c(),f("svg",He,t[12]||(t[12]=[s("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z","clip-rule":"evenodd"},null,-1)]))):(c(),f("svg",je,t[13]||(t[13]=[s("path",{"fill-rule":"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z","clip-rule":"evenodd"},null,-1)])))],10,Oe),s("button",{title:"Просмотр элемента",class:"text-white bg-[#673ab7] hover:bg-purple-700 rounded-full p-2",onClick:t[6]||(t[6]=n=>e.emit("view",e.task.id))},t[14]||(t[14]=[s("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[s("path",{"fill-rule":"evenodd",d:"M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z","clip-rule":"evenodd"})],-1)])),s("button",{title:"Обновить сейчас",class:"text-white bg-[#2196f3] hover:bg-blue-600 rounded-full p-2",onClick:t[7]||(t[7]=n=>e.emit("refresh",e.task.id))},t[15]||(t[15]=[s("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[s("path",{"fill-rule":"evenodd",d:"M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z","clip-rule":"evenodd"})],-1)]))])],2)}l(Fe,"_sfc_render$4");const K=I(Te,[["render",Fe]]),We=U({name:"IndexPage",components:{TaskCard:K},setup(){const e=window.vueRouter,t=b([]),o=b(!0),r=b(null),u=b(ie),p=k(()=>t.value.filter(d=>d.status!=="paused").length);async function n(){console.log("Loading tasks..."),o.value=!0,r.value=null;try{const d=await v.storage.local.get("tasks");if(d.tasks)if(Array.isArray(d.tasks))console.log("Tasks loaded:",d.tasks),t.value=[...d.tasks];else if(typeof d.tasks=="object"){console.warn("Tasks is an object, not an array. Converting to array:",d.tasks);const x=Object.values(d.tasks);Array.isArray(x)?(t.value=x,await v.storage.local.set({tasks:x}),console.log("Converted tasks saved back to storage as array")):(console.error("Failed to convert tasks to array"),t.value=[])}else console.log("tasks is neither array nor object:",typeof d.tasks),t.value=[];else console.log("No tasks found"),t.value=[]}catch(d){console.error("Error loading tasks:",d),r.value="Не удалось загрузить задачи: "+(d.message||"Неизвестная ошибка"),t.value=[]}finally{o.value=!1}}l(n,"loadTasks");async function i(){try{if(console.log("Saving tasks (length="+t.value.length+"):",t.value),!Array.isArray(t.value)){console.error("tasks.value is not an array:",t.value);return}const d=[...t.value];await v.storage.local.set({tasks:d}),console.log("Tasks saved successfully")}catch(d){console.error("Error saving tasks:",d),r.value="Не удалось сохранить задачи"}}l(i,"saveTasks");function y(){if(t.value.length>=u.value){alert("Достигнут лимит задач. Пожалуйста, удалите какую-либо задачу перед добавлением новой.");return}e?e.push("/new-task"):(console.warn("Router not available"),alert("Не удалось перейти на страницу добавления задачи"))}l(y,"handleAddTask");async function N(d,x){const g=t.value.findIndex(S=>S.id===d);g!==-1&&(t.value[g].interval=x,await i())}l(N,"updateTaskInterval");async function T(d,x){const g=t.value.findIndex(S=>S.id===d);g!==-1&&(t.value[g].status=x,await i())}l(T,"updateTaskStatus");function M(d){e?e.push(`/view-changes/${d}`):(console.warn("Router not available"),alert("Просмотр изменений временно недоступен"))}l(M,"viewTaskChanges");async function A(d){confirm("Вы уверены, что хотите удалить эту задачу?")&&(t.value=t.value.filter(x=>x.id!==d),await i())}l(A,"removeTask");function m(){v.runtime.openOptionsPage()}return l(m,"openOptions"),D(()=>{n()}),{tasks:t,loading:o,error:r,maxTasks:u,activeTaskCount:p,loadTasks:n,handleAddTask:y,updateTaskInterval:N,updateTaskStatus:T,viewTaskChanges:M,removeTask:A,openOptions:m}}}),qe={class:"min-h-[500px] w-[380px] p-3"},Ge={class:"flex justify-between items-center mb-6 pb-2 border-b"},Ke={class:"flex items-center space-x-2"},Ye={key:0,class:"flex justify-center items-center h-64"},Xe={key:1,class:"bg-red-50 border border-red-200 rounded-xl p-4 mt-4 text-center"},Je={class:"text-red-800 mb-2"},Qe={key:2,class:"flex flex-col items-center justify-center h-96 text-gray-400"},Ze={key:3},_e={class:"space-y-4"},et={key:4,class:"mt-4 pt-4 border-t text-center"},tt={class:"text-sm text-gray-500"};function st(e,t,o,r,u,p){const n=K;return c(),f("div",qe,[s("header",Ge,[t[6]||(t[6]=s("div",{class:"flex items-center"},[s("h1",{class:"text-2xl font-bold"}," Web Check ")],-1)),s("div",Ke,[s("button",{class:"bg-[#3e66fb] text-white p-2.5 rounded-full hover:bg-blue-700 transition-colors",title:"Добавить новую задачу",onClick:t[0]||(t[0]=(...i)=>e.handleAddTask&&e.handleAddTask(...i))},t[4]||(t[4]=[s("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-7 w-7",viewBox:"0 0 20 20",fill:"currentColor"},[s("path",{d:"M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z","fill-rule":"evenodd","clip-rule":"evenodd"})],-1)])),s("button",{class:"text-gray-600 hover:text-gray-900 p-2.5 rounded-full hover:bg-gray-100 transition-colors",title:"Настройки",onClick:t[1]||(t[1]=(...i)=>e.openOptions&&e.openOptions(...i))},t[5]||(t[5]=[s("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-7 w-7",viewBox:"0 0 20 20",fill:"currentColor"},[s("path",{d:"M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z","fill-rule":"evenodd","clip-rule":"evenodd"})],-1)]))])]),e.loading?(c(),f("div",Ye,t[7]||(t[7]=[s("div",{class:"animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-[#2d6cdf]"},null,-1),s("span",{class:"ml-3 text-gray-600"},"Загрузка задач...",-1)]))):e.error?(c(),f("div",Xe,[t[8]||(t[8]=s("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-12 w-12 mx-auto text-red-500 mb-2",viewBox:"0 0 20 20",fill:"currentColor"},[s("path",{d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z","fill-rule":"evenodd","clip-rule":"evenodd"})],-1)),s("p",Je,h(e.error),1),s("button",{class:"text-[#2d6cdf] hover:underline mt-2",onClick:t[2]||(t[2]=(...i)=>e.loadTasks&&e.loadTasks(...i))}," Попробовать снова ")])):e.tasks.length===0?(c(),f("div",Qe,[t[10]||(t[10]=s("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-16 w-16 mb-4 text-gray-300",viewBox:"0 0 20 20",fill:"currentColor"},[s("path",{d:"M5 4a3 3 0 00-3 3v6a3 3 0 003 3h10a3 3 0 003-3V7a3 3 0 00-3-3H5zm0 2a1 1 0 00-1 1v6a1 1 0 001 1h10a1 1 0 001-1V7a1 1 0 00-1-1H5z","fill-rule":"evenodd","clip-rule":"evenodd"})],-1)),t[11]||(t[11]=s("p",{class:"text-lg mb-6"}," Нет активных задач. ",-1)),s("button",{class:"bg-[#3e66fb] text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors text-lg font-medium",onClick:t[3]||(t[3]=(...i)=>e.handleAddTask&&e.handleAddTask(...i))},t[9]||(t[9]=[s("span",{class:"flex items-center"},[s("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6 mr-2",viewBox:"0 0 20 20",fill:"currentColor"},[s("path",{d:"M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z","fill-rule":"evenodd","clip-rule":"evenodd"})]),q(" Добавить задачу ")],-1)]))])):(c(),f("div",Ze,[s("div",_e,[(c(!0),f(le,null,re(e.tasks,i=>(c(),G(n,{key:i.id,task:i,"onUpdate:interval":e.updateTaskInterval,"onUpdate:status":e.updateTaskStatus,onView:e.viewTaskChanges,onRemove:e.removeTask},null,8,["task","onUpdate:interval","onUpdate:status","onView","onRemove"]))),128))])])),e.tasks.length>0?(c(),f("footer",et,[s("p",tt," Активно "+h(e.activeTaskCount)+" из "+h(e.maxTasks)+" задач ",1)])):P("",!0)])}l(st,"_sfc_render$3");const Y=I(We,[["render",st]]),at=U({name:"ViewChanges",setup(){const e=window.vueRouter,t=b(!0),o=b(null),r=b([]),u=k(()=>e?e.currentRoute.value.params.id:null),p=k(()=>o.value?.title||"Просмотр элемента"),n=k(()=>o.value?.url||"#"),i=k(()=>{if(!o.value?.url)return"";try{return new URL(o.value.url).hostname}catch{return o.value.url}});function y(m){return m?new Date(m).toLocaleString():""}l(y,"formatDate");function N(m){return`
        <html>
          <head>
            <style>
              body {
                margin: 0;
                padding: 10px;
                font-family: Arial, sans-serif;
                font-size: 14px;
              }
              .element-container {
                max-width: 100%;
                overflow: auto;
              }
            </style>
          </head>
          <body>
            <div class="element-container">${m||"<div>(Нет содержимого)</div>"}</div>
          </body>
        </html>
      `}l(N,"wrapHtmlWithStyle");async function T(){t.value=!0;try{const m=await v.storage.local.get("tasks");m.tasks&&Array.isArray(m.tasks)?(r.value=m.tasks,u.value&&(o.value=r.value.find(d=>d.id===u.value)||null),o.value||console.warn("Task not found:",u.value)):console.warn("No tasks found in storage")}catch(m){console.error("Error loading tasks:",m)}finally{t.value=!1}}l(T,"loadTasks");function M(){e?e.push("/"):window.history.back()}l(M,"goBack");async function A(){if(o.value)try{const m=r.value.findIndex(d=>d.id===o.value.id);m!==-1&&(r.value[m].status="unchanged",r.value[m].initialHtml=o.value.currentHtml,await v.storage.local.set({tasks:r.value}),M())}catch(m){console.error("Error resetting changes:",m),alert("Не удалось сбросить изменения")}}return l(A,"resetChanges"),D(()=>{T()}),{loading:t,task:o,taskId:u,taskTitle:p,taskUrl:n,displayUrl:i,formatDate:y,wrapHtmlWithStyle:N,goBack:M,resetChanges:A}}}),ot={class:"bg-white w-full min-h-[500px] w-[400px]"},nt={class:"flex items-center p-4 border-b"},lt={class:"flex-1 mx-2 truncate"},rt={class:"text-lg font-bold truncate"},it={class:"text-sm text-gray-500 truncate"},dt=["href"],ut={key:0,class:"flex flex-col items-center justify-center h-64"},ct={key:1,class:"flex flex-col items-center justify-center h-64"},gt={key:2,class:"p-4"},vt={class:"grid grid-cols-2 gap-4 mb-2"},ft={class:"text-xs text-gray-500 text-center"},pt={class:"text-xs text-gray-500 text-center"},mt={class:"grid grid-cols-2 gap-4 mb-4"},wt={class:"border border-gray-200 rounded overflow-hidden shadow-sm"},kt=["srcdoc"],bt={class:"border border-gray-200 rounded overflow-hidden shadow-sm"},ht=["srcdoc"],yt={class:"flex space-x-2 mt-4"},Tt=["href"];function xt(e,t,o,r,u,p){return c(),f("div",ot,[s("header",nt,[s("button",{title:"Назад",class:"mr-2 text-gray-600 hover:text-gray-900",onClick:t[0]||(t[0]=(...n)=>e.goBack&&e.goBack(...n))},t[3]||(t[3]=[s("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",viewBox:"0 0 20 20",fill:"currentColor"},[s("path",{d:"M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z","fill-rule":"evenodd","clip-rule":"evenodd"})],-1)])),s("div",lt,[s("div",rt,h(e.taskTitle),1),s("div",it,h(e.displayUrl),1)]),s("a",{href:e.taskUrl,target:"_blank",class:"text-blue-600 bg-blue-50 px-3 py-1 rounded text-sm hover:bg-blue-100 whitespace-nowrap flex items-center"},t[4]||(t[4]=[s("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4 mr-1",viewBox:"0 0 20 20",fill:"currentColor"},[s("path",{d:"M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"}),s("path",{d:"M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"})],-1),q(" Открыть страницу ")]),8,dt)]),e.loading?(c(),f("div",ut,t[5]||(t[5]=[s("div",{class:"animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-600"},null,-1),s("p",{class:"mt-4 text-gray-600"}," Загрузка изменений... ",-1)]))):e.task?(c(),f("div",gt,[t[8]||(t[8]=s("div",{class:"grid grid-cols-2 gap-4 mb-2"},[s("div",{class:"bg-gray-50 rounded p-2 text-center text-sm font-medium text-gray-700"}," Исходный вид "),s("div",{class:"bg-gray-50 rounded p-2 text-center text-sm font-medium text-gray-700"}," Текущий вид ")],-1)),s("div",vt,[s("div",ft,h(e.formatDate(e.task.createdAt)),1),s("div",pt,h(e.formatDate(e.task.lastCheckedAt)),1)]),s("div",mt,[s("div",wt,[s("iframe",{srcdoc:e.wrapHtmlWithStyle(e.task.initialHtml),class:"w-full h-64",frameborder:"0"},null,8,kt)]),s("div",bt,[s("iframe",{srcdoc:e.wrapHtmlWithStyle(e.task.currentHtml),class:"w-full h-64",frameborder:"0"},null,8,ht)])]),s("div",yt,[s("button",{class:"flex-1 py-2 rounded bg-purple-600 text-white hover:bg-purple-700",onClick:t[2]||(t[2]=(...n)=>e.resetChanges&&e.resetChanges(...n))}," Сбросить изменения "),s("a",{href:e.task.url,target:"_blank",class:"flex-1 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 text-center"}," Открыть сайт ",8,Tt)])])):(c(),f("div",ct,[t[6]||(t[6]=s("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-16 w-16 text-gray-300 mb-4",viewBox:"0 0 20 20",fill:"currentColor"},[s("path",{d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z","fill-rule":"evenodd","clip-rule":"evenodd"})],-1)),t[7]||(t[7]=s("p",{class:"text-gray-600 mb-4"}," Задача не найдена ",-1)),s("button",{class:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",onClick:t[1]||(t[1]=(...n)=>e.goBack&&e.goBack(...n))}," Назад ")]))])}l(xt,"_sfc_render$2");const X=I(at,[["render",xt],["__scopeId","data-v-edae2046"]]),$t=U({name:"TaskEditor",props:{task:{type:Object,required:!0},isEdit:{type:Boolean,default:!1},debug:{type:Boolean,default:!1}},emits:["save","cancel"],setup(e,{emit:t}){const o=b({...e.task}),r=b(null),u=k(()=>{try{return new URL(e.task.url).hostname}catch{return e.task.url}});function p(y){y.target.src="/icons/icon-16.png"}l(p,"onFaviconError");function n(){t("save",o.value)}l(n,"saveTask");function i(){t("cancel")}return l(i,"cancelEdit"),D(()=>{console.log("[TaskEditor] Task loaded:",e.task),setTimeout(()=>{r.value&&(r.value.focus(),r.value.select())},100)}),{editedTask:o,titleInput:r,displayUrl:u,onFaviconError:p,saveTask:n,cancelEdit:i,CHECK_INTERVALS:E}}}),Ct={class:"task-editor p-4 bg-white rounded-lg shadow"},Et={key:0,class:"text-xl font-bold mb-4"},Nt={class:"mb-3"},St={class:"mb-3"},Mt={class:"thumbnail-container border rounded-lg overflow-hidden bg-gray-50"},At=["src"],Rt={key:1,class:"bg-gray-100 w-full h-24 flex items-center justify-center text-gray-400"},zt={class:"mb-3"},It={class:"flex items-center border border-gray-300 rounded-md px-3 py-2"},Ut=["src"],Bt={class:"text-gray-800 truncate"},Dt={class:"mb-4"},Vt={key:0,class:"mb-3 p-3 bg-gray-100 rounded text-sm"},Lt={class:"block mt-1 text-xs bg-gray-200 p-2 rounded"},Pt={class:"flex justify-end space-x-3"};function Ot(e,t,o,r,u,p){return c(),f("div",Ct,[e.isEdit?(c(),f("h2",Et," Редактирование задачи ")):P("",!0),s("form",{onSubmit:t[4]||(t[4]=ue((...n)=>e.saveTask&&e.saveTask(...n),["prevent"]))},[s("div",Nt,[t[5]||(t[5]=s("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Название задачи",-1)),H(s("input",{ref:"titleInput","onUpdate:modelValue":t[0]||(t[0]=n=>e.editedTask.title=n),type:"text",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-[#3e66fb] focus:border-[#3e66fb]",required:""},null,512),[[de,e.editedTask.title]])]),s("div",St,[t[6]||(t[6]=s("p",{class:"text-sm text-gray-600 mb-1"}," Выбранный элемент: ",-1)),s("div",Mt,[e.task.thumbnailUrl?(c(),f("iframe",{key:0,src:e.task.thumbnailUrl,frameborder:"0",class:"w-full h-24 object-contain"},null,8,At)):(c(),f("div",Rt," Изображение недоступно "))])]),s("div",zt,[t[7]||(t[7]=s("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Источник",-1)),s("div",It,[s("img",{src:e.task.faviconUrl||"/icons/icon-16.png",alt:"Site icon",class:"w-5 h-5 mr-2",onError:t[1]||(t[1]=(...n)=>e.onFaviconError&&e.onFaviconError(...n))},null,40,Ut),s("span",Bt,h(e.displayUrl),1)])]),s("div",Dt,[t[9]||(t[9]=s("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Частота проверок",-1)),H(s("select",{"onUpdate:modelValue":t[2]||(t[2]=n=>e.editedTask.interval=n),class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-[#3e66fb] focus:border-[#3e66fb]"},t[8]||(t[8]=[W('<option value="10s"> Каждые 10 секунд (отладка) </option><option value="15m"> Каждые 15 минут </option><option value="1h"> Каждый час </option><option value="3h"> Каждые 3 часа </option><option value="1d"> Раз в день </option>',5)]),512),[[F,e.editedTask.interval]])]),e.debug?(c(),f("div",Vt,[t[10]||(t[10]=s("p",{class:"font-medium"}," Селектор для отслеживания: ",-1)),s("code",Lt,h(e.task.selector),1)])):P("",!0),s("div",Pt,[s("button",{type:"button",class:"px-4 py-2 text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200 transition",onClick:t[3]||(t[3]=(...n)=>e.cancelEdit&&e.cancelEdit(...n))}," Отмена "),t[11]||(t[11]=s("button",{type:"submit",class:"px-4 py-2 text-white bg-[#3e66fb] rounded-md hover:bg-blue-700 transition"}," Сохранить ",-1))])],32)])}l(Ot,"_sfc_render$1");const J=I($t,[["render",Ot]]),Ht=U({name:"NewTaskPage",components:{TaskEditor:J},setup(){const e=window.vueRouter,t=b({}),o=b(!0),r=b("Инициализация..."),u=b(null),p=b(!1),n=b(!1),i=b(null);let y=null,N=null,T=0;console.log("[NewTask] 🎯 NewTask component initializing...");async function M(){console.log("[NewTask] 📂 loadTaskData called"),o.value=!0,r.value="Проверка данных задачи...",u.value=null;try{const a=await v.storage.local.get("newTaskData");if(console.log("[NewTask] 📋 Initial storage check result:",a),a.newTaskData){console.log("[NewTask] ✅ Found existing task data:",a.newTaskData),t.value=a.newTaskData,p.value=!1,o.value=!1,await v.storage.local.remove("newTaskData"),console.log("[NewTask] 🗑️ Removed newTaskData from storage");return}console.log("[NewTask] 🎯 No existing data, activating element selection"),await A(),S()}catch(a){console.error("[NewTask] ❌ Error in loadTaskData:",a),u.value="Не удалось загрузить данные о задаче: "+(a.message||"Неизвестная ошибка"),p.value=!1,o.value=!1}}l(M,"loadTaskData");async function A(){console.log("[NewTask] 🎯 activateElementSelection called");try{const a=await v.tabs.query({active:!0,currentWindow:!0});if(console.log("[NewTask] 📋 Active tabs found:",a.length),!a.length)throw new Error("Не удалось получить активную вкладку");const w=a[0];i.value=w.id,console.log("[NewTask] 🔗 Active tab ID:",w.id,"URL:",w.url),r.value="Активация выбора элемента...";const C=await v.runtime.sendMessage({action:"activateElementSelection",tabId:w.id});console.log("[NewTask] 📤 Element selection activation response:",C),p.value=!0,o.value=!1,console.log("[NewTask] ✅ Element selection activated, popup stays open")}catch(a){console.error("[NewTask] ❌ Error activating element selection:",a),u.value="Не удалось активировать выбор элемента: "+(a.message||"Неизвестная ошибка"),p.value=!1,o.value=!1}}l(A,"activateElementSelection");async function m(){console.log("[NewTask] 🔄 Switching to manual tab:",i.value);try{if(i.value){await v.tabs.update(i.value,{active:!0});const a=await v.tabs.get(i.value);a.windowId&&await v.windows.update(a.windowId,{focused:!0}),console.log("[NewTask] ✅ Switched to tab successfully")}}catch(a){console.error("[NewTask] ❌ Error switching to tab:",a)}}l(m,"switchToManualTab");async function d(){console.log("[NewTask] ❌ Cancelling element selection");try{i.value&&await v.runtime.sendMessage({action:"cancelElementSelection",tabId:i.value})}catch(a){console.error("[NewTask] ❌ Error cancelling element selection:",a)}$(),g()}l(d,"cancelSelection");async function x(a){console.log("[NewTask] 💾 Saving task:",a);try{o.value=!0,r.value="Сохранение задачи...";const w=await v.storage.local.get("tasks");let C=[];w.tasks&&(Array.isArray(w.tasks)?C=[...w.tasks]:typeof w.tasks=="object"&&(console.log("[NewTask] Converting tasks object to array:",w.tasks),C=Object.values(w.tasks))),C.push(a),await v.storage.local.set({tasks:C}),console.log("[NewTask] ✅ Task saved successfully:",a.id),$(),g()}catch(w){console.error("[NewTask] ❌ Error saving task:",w),u.value="Не удалось сохранить задачу: "+(w.message||"Неизвестная ошибка"),o.value=!1}}l(x,"saveTask");function g(){console.log("[NewTask] 🔙 Going back to main page"),$(),e?e.push("/"):(console.warn("[NewTask] Router not available, closing popup"),window.close())}l(g,"goBack");function S(){console.log("[NewTask] 🔄 Starting AGGRESSIVE polling every 300ms"),r.value="Ожидание выбора элемента...",T=0,N=setInterval(async()=>{T++,console.log(`[NewTask] 🔍 Polling attempt #${T}`);try{const a=await v.storage.local.get("newTaskData");if(a.newTaskData){console.log("[NewTask] 🎉 FOUND newTaskData via aggressive polling:",a.newTaskData),t.value=a.newTaskData,p.value=!1,o.value=!1,await v.storage.local.remove("newTaskData"),console.log("[NewTask] 🗑️ newTaskData removed from storage"),$(),console.log("[NewTask] 🎯 Task editor should now be visible!");return}T%10===0&&(r.value=`Ожидание выбора элемента... (${T}/100)`,console.log(`[NewTask] 💭 Still waiting after ${T} attempts`)),T>=100&&(console.log("[NewTask] ⏰ Stopping polling due to timeout"),$(),u.value="Превышено время ожидания выбора элемента. Попробуйте еще раз.",o.value=!1,p.value=!1)}catch(a){console.error("[NewTask] ❌ Error in aggressive polling:",a)}},300)}l(S,"startAggressivePolling");function $(){N&&(clearInterval(N),N=null,console.log("[NewTask] ⏹️ Polling stopped"))}l($,"stopPolling");function R(){console.log("[NewTask] 📞 Setting up message listener"),y=l((a,w,C)=>{if(console.log("[NewTask] 📨 Received message:",a),a.action==="ping")return console.log("[NewTask] 🏓 Ping received"),C({status:"pong"}),!0;a.action==="elementCaptured"&&(console.log("[NewTask] 🎯 Element captured via direct message!"),t.value=a.task,p.value=!1,o.value=!1,$(),C({received:!0}))},"messageListener"),v.runtime.onMessage.addListener(y)}l(R,"setupMessageListener");function B(){console.log("[NewTask] 📂 Setting up storage listener"),v.storage.onChanged.addListener((a,w)=>{console.log("[NewTask] 📂 Storage changed:",Object.keys(a),"namespace:",w),w==="local"&&a.newTaskData&&a.newTaskData.newValue&&(console.log("[NewTask] 🎉 newTaskData detected via storage listener!"),t.value=a.newTaskData.newValue,p.value=!1,o.value=!1,$(),v.storage.local.remove("newTaskData"),console.log("[NewTask] 🎯 Task editor activated via storage listener!"))})}return l(B,"setupStorageListener"),D(()=>{console.log("[NewTask] 🎬 Component mounted - setting up everything"),R(),B(),M()}),ce(()=>{if(console.log("[NewTask] 🎬 Component unmounting - cleaning up"),$(),y&&v.runtime.onMessage.removeListener(y),i.value&&p.value)try{v.runtime.sendMessage({action:"cancelElementSelection",tabId:i.value}).catch(()=>{})}catch{}}),{task:t,loading:o,loadingMessage:r,error:u,elementSelection:p,debug:n,saveTask:x,goBack:g,cancelSelection:d,switchToManualTab:m}}}),jt={class:"min-h-[500px] w-[380px] h-[420px] p-3 overflow-y-auto"},Ft={class:"flex justify-between items-center mb-6 pb-2 border-b sticky top-0 bg-white z-10"},Wt={key:0,class:"flex flex-col justify-center items-center h-64"},qt={class:"ml-3 text-gray-600 mt-2"},Gt={key:1,class:"bg-red-50 border border-red-200 rounded-xl p-4 mt-4 text-center"},Kt={class:"text-red-800 mb-2"},Yt={key:2,class:"bg-blue-50 border border-blue-200 rounded-xl p-4 mt-4 text-center"},Xt={class:"flex gap-2 justify-center"};function Jt(e,t,o,r,u,p){const n=J;return c(),f("div",jt,[s("header",Ft,[t[5]||(t[5]=s("div",{class:"flex items-center"},[s("h1",{class:"text-2xl font-bold"}," Новая задача ")],-1)),s("button",{title:"Закрыть",class:"text-gray-600 hover:text-gray-900 p-2.5 rounded-full hover:bg-gray-100 transition-colors",onClick:t[0]||(t[0]=(...i)=>e.goBack&&e.goBack(...i))},t[4]||(t[4]=[s("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-7 w-7",viewBox:"0 0 20 20",fill:"currentColor"},[s("path",{d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z","fill-rule":"evenodd","clip-rule":"evenodd"})],-1)]))]),e.loading?(c(),f("div",Wt,[t[6]||(t[6]=s("div",{class:"animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-[#2d6cdf]"},null,-1)),s("span",qt,h(e.loadingMessage),1)])):e.error?(c(),f("div",Gt,[t[7]||(t[7]=s("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-12 w-12 mx-auto text-red-500 mb-2",viewBox:"0 0 20 20",fill:"currentColor"},[s("path",{d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z","fill-rule":"evenodd","clip-rule":"evenodd"})],-1)),s("p",Kt,h(e.error),1),s("button",{class:"text-[#2d6cdf] hover:underline mt-2",onClick:t[1]||(t[1]=(...i)=>e.goBack&&e.goBack(...i))}," Вернуться назад ")])):e.elementSelection?(c(),f("div",Yt,[t[8]||(t[8]=s("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-12 w-12 mx-auto text-blue-500 mb-2",viewBox:"0 0 20 20",fill:"currentColor"},[s("path",{d:"M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 001.415-1.415L11 9.586V6z","fill-rule":"evenodd","clip-rule":"evenodd"})],-1)),t[9]||(t[9]=s("p",{class:"text-blue-800 mb-2"}," Выберите элемент на странице для отслеживания. ",-1)),t[10]||(t[10]=s("p",{class:"text-blue-600 text-sm mb-4"}," Popup остается открытым. Переключитесь на веб-страницу и кликните на элемент. ",-1)),s("div",Xt,[s("button",{class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors",onClick:t[2]||(t[2]=(...i)=>e.switchToManualTab&&e.switchToManualTab(...i))}," Переключиться на веб-страницу "),s("button",{class:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors",onClick:t[3]||(t[3]=(...i)=>e.cancelSelection&&e.cancelSelection(...i))}," Отменить ")])])):(c(),G(n,{key:3,task:e.task,"is-edit":!1,debug:e.debug,onSave:e.saveTask,onCancel:e.goBack},null,8,["task","debug","onSave","onCancel"]))])}l(Jt,"_sfc_render");const Q=I(Ht,[["render",Jt]]);console.log("[ROUTER] Initializing router...");console.log("[ROUTER] Index component:",Y);console.log("[ROUTER] ViewChanges component:",X);console.log("[ROUTER] NewTask component:",Q);const Z=[{path:"/",name:"Index",component:Y},{path:"/view-changes/:id",name:"ViewChanges",component:X},{path:"/new-task",name:"NewTask",component:Q}];console.log("[ROUTER] Routes defined:",Z);const O=ge({history:ve(),routes:Z});console.log("[ROUTER] Router created");window.vueRouter=O;O.beforeEach((e,t)=>(console.log(`[ROUTER] Navigating from "${t.path}" to "${e.path}"`),!0));O.afterEach(e=>{console.log(`[ROUTER] Navigation to "${e.path}" complete`)});var Qt=O;const z=l((e,...t)=>{console.log(`[CSP-SAFE] ${e}`,...t)},"log");z("Starting popup initialization...");const V=fe(ye);V.use(Qt);z("Router attached");const Zt=pe();V.use(Zt);z("Pinia attached");const _t=navigator.language.split("-")[0]||"en",j={en:we,ru:me},_=l(e=>{const t=j[_t]||j.en,o=e.split(".");let r=t;for(const u of o)if(r&&typeof r=="object"&&!Array.isArray(r)&&u in r)r=r[u];else return e;return typeof r=="string"?r:e},"t");V.config.globalProperties.$t=_;window.t=_;V.config.errorHandler=e=>{console.error("[CSP-SAFE] Error:",e);const t=document.getElementById("app");if(t){const o=e instanceof Error?e.message:"Неизвестная ошибка";t.innerHTML=`
      <div style="padding: 20px; color: #e53e3e; background: #fff5f5; border: 1px solid #fc8181; border-radius: 5px; margin: 20px;">
        <h3 style="font-weight: bold; margin-bottom: 10px;">Ошибка загрузки</h3>
        <p>${o}</p>
        <p style="margin-top: 10px; font-size: 14px; color: #718096;">
          Попробуйте перезапустить расширение
        </p>
      </div>
    `}};try{document.getElementById("app")?(V.mount("#app"),z("App mounted successfully")):z("Error: #app element not found!")}catch(e){const t=e instanceof Error?e.message:"Unknown error";console.error("[CSP-SAFE] Mount error:",t)}window.addEventListener("load",()=>{z("Page fully loaded")});
