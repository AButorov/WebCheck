# Тестирование системы надёжности WebCheck

## Обзор новых компонентов

После завершения этапа "Обработка ограничений и повышение надёжности" в систему добавлены:

### 1. Система очередей задач (`src/background/taskQueue.ts`)
- Последовательная обработка задач через offscreen API
- Автоматические повторные попытки с экспоненциальной задержкой
- Детальная статистика производительности
- Защита от переполнения очереди

### 2. Менеджер надёжности (`src/background/reliabilityManager.ts`)
- Периодический мониторинг здоровья offscreen-документов
- Автоматическое восстановление при сбоях
- Система кэширования для оптимизации
- Диагностика с рекомендациями

### 3. Улучшенный offscreen-документ (`src/offscreen/offscreen.js`)
- Повторные попытки для каждого запроса
- Детальная статистика работы
- Улучшенная очистка ресурсов
- Обработка различных типов ошибок

## Инструкции по тестированию

### Шаг 1: Сборка расширения
```bash
cd /Users/butorov.ap/Documents/005_Programm/012_TS_vue/002_WebCheck
./build.sh
```

### Шаг 2: Установка в Chrome
1. Откройте `chrome://extensions/`
2. Включите режим разработчика
3. Нажмите "Загрузить распакованное расширение"
4. Выберите папку `dist`
5. Перезапустите браузер для полной инициализации

### Шаг 3: Базовое тестирование
1. **Создание задачи**:
   - Откройте попап расширения
   - Нажмите "Добавить задачу"
   - Выберите элемент на любой веб-странице
   - Установите интервал проверки 10 секунд (для быстрого тестирования)

2. **Проверка фонового мониторинга**:
   - Задача должна автоматически проверяться каждые 10 секунд
   - В консоли Service Worker должны появляться логи системы очередей
   - Бейдж расширения должен обновляться при изменениях

### Шаг 4: Тестирование надёжности
1. **Симуляция сбоев**:
   ```javascript
   // В консоли Service Worker выполните:
   chrome.runtime.reload() // Перезагрузка расширения
   ```
   - Система должна автоматически восстановиться
   - Мониторинг должен продолжиться без потери задач

2. **Проверка статистики**:
   ```javascript
   // В консоли Service Worker:
   // Получение статистики мониторинга
   chrome.runtime.sendMessage({type: 'get-monitoring-stats'}).then(console.log)
   
   // Получение статистики производительности  
   chrome.runtime.sendMessage({type: 'get-performance-stats'}).then(console.log)
   ```

### Шаг 5: Тестирование очереди задач
1. **Создание нескольких задач одновременно**:
   - Создайте 3-5 задач с интервалом 10 секунд
   - Все задачи должны обрабатываться последовательно
   - Не должно быть конфликтов или потери данных

2. **Проверка статистики очереди**:
   ```javascript
   // В консоли Service Worker:
   import { getQueueStats } from './background/taskQueue.js'
   console.log(getQueueStats())
   ```

### Шаг 6: Тестирование восстановления
1. **Принудительное закрытие offscreen-документа**:
   ```javascript
   // В консоли Service Worker:
   chrome.offscreen.closeDocument()
   ```
   - Система должна автоматически пересоздать документ
   - Мониторинг должен продолжиться без сбоев

2. **Проверка диагностики**:
   ```javascript
   // В консоли Service Worker:
   import { performDiagnostics } from './background/reliabilityManager.js'
   performDiagnostics().then(console.log)
   ```

## Возможные проблемы и их решения

### Проблема: Ошибки в консоли о CORS
**Решение**: Это нормальное поведение для некоторых сайтов. Система автоматически использует fallback через вкладки.

### Проблема: Задачи не обрабатываются
**Решение**: 
1. Проверьте консоль Service Worker на ошибки
2. Убедитесь, что offscreen-документ создан
3. Проверьте статистику надёжности

### Проблема: Высокое потребление памяти
**Решение**: Система автоматически очищает неиспользуемые ресурсы. При необходимости можно принудительно очистить очередь.

## Команды для отладки

### Получение полной диагностики системы:
```javascript
// В консоли Service Worker:
async function fullDiagnostics() {
  const monitoring = await chrome.runtime.sendMessage({type: 'get-monitoring-stats'})
  const performance = await chrome.runtime.sendMessage({type: 'get-performance-stats'})
  
  console.log('=== FULL SYSTEM DIAGNOSTICS ===')
  console.log('Monitoring Stats:', monitoring)
  console.log('Performance Stats:', performance)
  console.log('================================')
}

fullDiagnostics()
```

### Принудительная проверка задачи:
```javascript
// В консоли Service Worker (замените TASK_ID на реальный ID):
import { forceCheckTask } from './background/monitor/index.js'
forceCheckTask('TASK_ID').then(console.log)
```

### Тестирование offscreen API:
```javascript
// В консоли Service Worker:
import { testOffscreenMonitoring } from './background/monitor/index.js'
testOffscreenMonitoring('https://example.com', 'h1').then(console.log)
```

## Метрики успешности

Система считается работающей корректно, если:

1. **Надёжность**: 
   - Успешность операций > 90%
   - Автоматическое восстановление работает < 5 секунд
   - Нет потери задач при перезапуске

2. **Производительность**:
   - Среднее время обработки задачи < 10 секунд
   - Размер очереди не превышает 10 элементов
   - Потребление памяти остается стабильным

3. **Стабильность**:
   - Система здоровья показывает "healthy"
   - Количество ошибок подряд < 3
   - Offscreen-документ отвечает на ping

## Рекомендации по дальнейшему развитию

1. **Пользовательский интерфейс**: Добавить страницу статистики в настройки расширения
2. **Оптимизация**: Реализовать интеллектуальное планирование задач
3. **Мониторинг**: Добавить экспорт статистики для анализа
4. **Безопасность**: Реализовать дополнительную валидацию селекторов

---

**Система готова к использованию и обладает высокой надёжностью!** ✅
